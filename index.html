<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>STEVENSON</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="stv-nav.css">
<style>
  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  :root {
    --nav-height: 48px;
    --font: 'IBM Plex Mono', monospace;
    --black: #000;
    --white: #fff;
    --gray: #999;
    --light-gray: #ccc;
    --transition-speed: 0.45s;
    --ease: cubic-bezier(0.4, 0, 0.2, 1);
    --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  html, body {
    height: 100%;
    overflow: hidden;
    font-family: var(--font);
    background: var(--white);
    color: var(--black);
    -webkit-font-smoothing: antialiased;
  }

  body {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  /* ─── SCROLLBAR ─── */
  ::-webkit-scrollbar { width: 0; height: 0; }

  /* ─── FILTER BAR ─── */
  .nav-filters {
    position: fixed;
    top: calc(48px + env(safe-area-inset-top, 0px));
    left: 0;
    width: 100%;
    background: var(--white);
    z-index: 99;
    transition: opacity var(--transition-speed) var(--ease);
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    justify-content: center;
    padding: 4px 60px;
  }

  .nav-filters button {
    font-family: var(--font);
    font-size: 11px;
    letter-spacing: 0.02em;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray);
    padding: 2px 1px;
    transition: color 0.2s;
    text-transform: uppercase;
  }

  .nav-filters button.active {
    color: var(--black);
  }

  .nav-filters button:hover {
    color: var(--black);
  }

  /* ─── SPACER ─── */
  .nav-spacer {
    height: var(--nav-height);
    width: 100%;
    flex-shrink: 0;
  }

  /* ─── APP CONTAINER ─── */
  #app {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ─── GRID VIEW ─── */
  #grid-view {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-top: calc(48px + 30px + env(safe-area-inset-top, 0px));
    transition: opacity 0.45s var(--ease), transform 0.45s var(--ease);
  }

  #grid-view.dimmed {
    opacity: 0.15;
    transform: scale(0.97);
    pointer-events: none;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 0;
    padding: 0;
  }

  @media (max-width: 900px) {
    .grid { grid-template-columns: repeat(4, 1fr); }
  }
  @media (max-width: 600px) {
    .grid { grid-template-columns: repeat(3, 1fr); }

    .nav-filters {
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 10px;
      padding: 4px 50px;
    }
    .nav-filters button {
      font-size: 9px;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .grid-item { padding: 4px 2px 6px; }
    .grid-item-title { font-size: 9px; margin-top: 4px; }

    .detail-image-area { padding: 12px 40px; }
    .detail-info { padding: 12px 16px 32px; }
    .arrow { font-size: 22px; padding: 10px; }
    .arrow-left { left: 4px; }
    .arrow-right { right: 4px; }
  }
  @media (max-width: 400px) {
    .grid { grid-template-columns: repeat(2, 1fr); }

    .nav-filters { gap: 8px; }
    .nav-filters button { font-size: 8px; letter-spacing: 0; }
    .grid-item { padding: 3px 2px 5px; }
    .grid-item-title { font-size: 8px; }
  }

  /* ─── GRID ITEM ─── */
  .grid-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 6px 4px 10px;
    cursor: pointer;
    transition: transform 0.25s var(--ease), opacity 0.25s var(--ease);
    position: relative;
  }

  .grid-item:hover {
    transform: scale(1.03);
  }

  .grid-item:active {
    transform: scale(0.97);
  }

  .grid-item-img-wrap {
    width: 100%;
    aspect-ratio: 1 / 1;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background: #fafafa;
  }

  .grid-item-img-wrap img {
    max-width: 92%;
    max-height: 92%;
    object-fit: contain;
    transition: transform 0.3s var(--ease);
  }

  .grid-item:hover .grid-item-img-wrap img {
    transform: scale(1.05);
  }

  .grid-item-title {
    margin-top: 6px;
    font-size: 10px;
    text-align: center;
    color: var(--black);
    letter-spacing: 0.02em;
    text-transform: uppercase;
    line-height: 1.4;
    max-width: 100%;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    padding: 0 2px;
  }

  /* ─── DETAIL VIEW ─── */
  #detail-view {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--white);
    z-index: 90;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
  }

  #detail-view.active {
    opacity: 1;
    pointer-events: all;
  }

  /* ─── DETAIL NAV ─── */
  .detail-nav {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: var(--nav-height);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 110;
    background: var(--white);
  }

  .detail-nav button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 22px;
    color: var(--black);
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
  }

  .detail-nav button:hover {
    opacity: 0.5;
  }

  /* ─── DETAIL CONTENT ─── */
  .detail-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    padding-top: var(--nav-height);
  }

  .detail-image-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    min-height: 50vh;
    padding: 20px 60px;
  }

  .detail-image-area img {
    max-width: 100%;
    max-height: 65vh;
    object-fit: contain;
    will-change: transform;
  }

  .detail-image-area img.switching {
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  /* ─── CAROUSEL ARROWS ─── */
  .arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 28px;
    color: var(--black);
    cursor: pointer;
    padding: 16px;
    transition: opacity 0.2s;
    z-index: 5;
    user-select: none;
  }

  .arrow:hover { opacity: 0.4; }
  .arrow-left { left: 16px; }
  .arrow-right { right: 16px; }

  /* ─── DOT INDICATORS ─── */
  .dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 12px 0;
  }

  .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--light-gray);
    transition: background 0.2s;
    cursor: pointer;
  }

  .dot.active {
    background: var(--black);
  }

  /* ─── DETAIL INFO ─── */
  .detail-info {
    text-align: center;
    padding: 16px 20px 40px;
  }

  .detail-title {
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .detail-artist {
    font-size: 12px;
    color: var(--gray);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .detail-price {
    font-size: 14px;
    font-weight: 400;
    margin-bottom: 8px;
  }

  .detail-location {
    font-size: 12px;
    color: var(--gray);
    margin-bottom: 16px;
  }

  .detail-score {
    display: inline-block;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--gray);
    margin-bottom: 4px;
  }

  .detail-value {
    display: block;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--gray);
    margin-bottom: 12px;
  }

  .detail-link {
    display: inline-block;
    font-family: var(--font);
    font-size: 12px;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: var(--black);
    border: 1px solid var(--black);
    padding: 10px 28px;
    text-decoration: none;
    transition: background 0.2s, color 0.2s;
  }

  .detail-link:hover {
    background: var(--black);
    color: var(--white);
  }

  /* ─── EXPAND BUTTON ─── */
  .expand-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    margin: 0 auto 16px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 22px;
    color: var(--gray);
    transition: color 0.2s, transform 0.3s var(--ease);
  }

  .expand-btn:hover {
    color: var(--black);
  }

  .expand-btn.open {
    transform: rotate(45deg);
  }

  .detail-extra {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s var(--ease), opacity 0.3s;
    opacity: 0;
  }

  .detail-extra.open {
    max-height: 200px;
    opacity: 1;
  }

  /* ─── NEIGHBOR NAV ─── */
  .neighbor-nav {
    position: fixed;
    bottom: 20px;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 40px;
    z-index: 95;
    opacity: 0;
    transition: opacity 0.3s var(--ease);
    pointer-events: none;
  }

  .neighbor-nav.active {
    opacity: 1;
    pointer-events: all;
  }

  .neighbor-nav button {
    background: none;
    border: none;
    cursor: pointer;
    font-family: var(--font);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--gray);
    transition: color 0.2s;
  }

  .neighbor-nav button:hover {
    color: var(--black);
  }

  /* ─── FOOTER ─── */
  .footer {
    padding: 24px 20px;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .footer.visible {
    opacity: 1;
  }

  .footer a {
    font-size: 11px;
    color: var(--gray);
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    transition: color 0.2s;
  }

  .footer a:hover {
    color: var(--black);
  }

  /* ─── LOADING ─── */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    font-size: 14px;
    color: var(--gray);
    letter-spacing: 0.05em;
  }

  /* ─── LIKE BUTTON (grid) ─── */
  .grid-item-like {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(255, 255, 255, 0.85);
    border: none;
    cursor: pointer;
    font-size: 14px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s, transform 0.15s var(--ease);
    z-index: 2;
    color: var(--gray);
    line-height: 1;
  }

  .grid-item:hover .grid-item-like,
  .grid-item-like.liked {
    opacity: 1;
  }

  .grid-item-like.liked {
    color: #c0392b;
  }

  .grid-item-like:hover {
    transform: scale(1.15);
  }

  .grid-item-like:active {
    transform: scale(0.9);
  }

  /* ─── LIKE BUTTON (detail) ─── */
  #like-btn {
    transition: transform 0.2s var(--ease-spring);
  }

  #like-btn.liked {
    color: #c0392b !important;
  }

  #like-btn:active {
    transform: scale(0.85);
  }

  @keyframes heartPop {
    0% { transform: scale(1); }
    40% { transform: scale(1.35); }
    100% { transform: scale(1); }
  }

  #like-btn.pop {
    animation: heartPop 0.35s var(--ease-spring);
  }

  /* ─── FOR YOU BADGE ─── */
  .nav-filters button[data-price="foryou"] {
    color: #c0392b;
  }

  .nav-filters button[data-price="foryou"].active {
    color: #c0392b;
  }

  /* ─── STAGGERED ENTRANCE ─── */
  .grid-item {
    opacity: 0;
    transform: translateY(16px);
    animation: fadeUp 0.4s var(--ease) forwards;
  }

  @keyframes fadeUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
</head>
<body>

<div id="app">
  <!-- NAV -->
  <nav class="stv-nav" data-stv-theme="light" data-stv-page="gallery" id="main-nav">
    <span class="stv-nav-title">STEVENSON</span>
    <span class="stv-nav-right" id="nav-count"></span>
  </nav>

  <!-- FILTER BAR -->
  <div class="nav-filters" id="price-filters">
    <button class="active" data-price="all">ALL</button>
    <button data-price="under50">&lt;$50</button>
    <button data-price="50to200">$50–200</button>
    <button data-price="200to1000">$200–1K</button>
    <button data-price="over1000">$1K+</button>
    <button data-price="best">BEST</button>
    <button data-price="gems">GEMS</button>
    <button data-price="foryou" style="display:none;">FOR YOU</button>
  </div>

  <!-- GRID -->
  <div id="grid-view">
    <div class="grid" id="grid"></div>
    <div class="footer">
      <a href="#">About</a>
      <a href="#">Contact</a>
      <a href="#">Terms</a>
      <a href="#">Privacy</a>
    </div>
  </div>

  <!-- DETAIL -->
  <div id="detail-view">
    <div class="detail-nav">
      <button onclick="closeDetail()" aria-label="Back">&#8249;</button>
      <div style="display:flex;gap:4px;">
        <button id="like-btn" onclick="toggleLike()" aria-label="Like" style="font-size:18px;" title="Like">&#9825;</button>
        <button id="share-btn" onclick="copyPermalink()" aria-label="Copy link" style="font-size:14px;" title="Copy link">&#8599;</button>
      </div>
    </div>
    <div class="detail-content">
      <div class="detail-image-area">
        <button class="arrow arrow-left" onclick="prevImage()">&#8249;</button>
        <img id="detail-img" src="" alt="">
        <button class="arrow arrow-right" onclick="nextImage()">&#8250;</button>
      </div>
      <div class="dots" id="dots"></div>
      <div class="detail-info">
        <div class="detail-title" id="detail-title"></div>
        <div class="detail-artist" id="detail-artist"></div>
        <div class="detail-price" id="detail-price"></div>
        <div class="detail-score" id="detail-score"></div>
        <div class="detail-value" id="detail-value"></div>
        <button class="expand-btn" id="expand-btn" onclick="toggleExtra()">+</button>
        <div class="detail-extra" id="detail-extra">
          <div class="detail-location" id="detail-location"></div>
          <a class="detail-link" id="detail-link" href="#" target="_blank" rel="noopener">VIEW LISTING</a>
        </div>
      </div>
    </div>
  </div>

  <!-- NEIGHBOR NAV -->
  <div class="neighbor-nav" id="neighbor-nav">
    <button onclick="prevPainting()">&#8249; PREV</button>
    <button onclick="nextPainting()">NEXT &#8250;</button>
  </div>
</div>

<script>
  let paintings = [];
  let filtered = [];
  let currentIndex = -1;
  let currentImageIndex = 0;
  let currentPrice = 'all';
  let flipTimeouts = [];
  let displayedCount = 0;
  const PAGE_SIZE = 60;

  // Likes state (shared via Redis)
  let likedIds = new Set();

  function clearFlipTimeouts() {
    flipTimeouts.forEach(id => clearTimeout(id));
    flipTimeouts = [];
  }

  // Extract Craigslist post ID from URL
  function getPaintingId(painting) {
    if (!painting.url) return null;
    const m = painting.url.match(/\/(\d+)\.html/);
    return m ? m[1] : null;
  }

  // Find painting by ID across all paintings
  function findPaintingById(id) {
    return paintings.findIndex(p => getPaintingId(p) === id);
  }

  // Update URL hash without triggering popstate
  let suppressHashChange = false;
  function setHash(id) {
    suppressHashChange = true;
    if (id) {
      history.pushState(null, '', '#' + id);
    } else {
      history.pushState(null, '', window.location.pathname);
    }
    suppressHashChange = false;
  }

  // Build API URL from current filter
  function buildApiUrl() {
    let url = '/api/paintings?';
    const params = [];
    if (currentPrice === 'under50') { params.push('max_price=50'); }
    else if (currentPrice === '50to200') { params.push('min_price=50', 'max_price=200'); }
    else if (currentPrice === '200to1000') { params.push('min_price=200', 'max_price=1000'); }
    else if (currentPrice === 'over1000') { params.push('min_price=1000'); }
    else if (currentPrice === 'best') { params.push('filter=best', 'sort=art_score'); }
    else if (currentPrice === 'gems') { params.push('filter=gems', 'sort=value_score'); }
    return url + params.join('&');
  }

  // Fetch paintings from API with current filters
  let fetchController = null;
  function fetchPaintings() {
    if (fetchController) fetchController.abort();
    fetchController = new AbortController();

    if (currentPrice === 'foryou') {
      fetchRecommendations();
      return;
    }

    const url = buildApiUrl();
    fetch(url, { signal: fetchController.signal })
      .then(r => r.json())
      .then(data => {
        paintings = data.paintings.filter(p => p.images && p.images.length > 0);
        filtered = [...paintings];
        document.getElementById('nav-count').textContent = filtered.length;
        renderGrid();
        if (window.location.hash) checkPermalink();
      })
      .catch(e => { if (e.name !== 'AbortError') console.error(e); });
  }

  // Initial load
  fetchPaintings();

  // Shorten title for grid
  function shortTitle(title) {
    const clean = title.replace(/[^\w\s]/g, '').trim();
    if (clean.length > 24) return clean.substring(0, 22) + '...';
    return clean;
  }

  // Apply price filters — fetches from API with server-side filtering
  function applyFilters() {
    fetchPaintings();
  }

  // Price filter click handlers
  document.querySelectorAll('#price-filters button').forEach(btn => {
    btn.addEventListener('click', () => {
      currentPrice = btn.dataset.price;
      document.querySelectorAll('#price-filters button').forEach(b => {
        b.classList.toggle('active', b.dataset.price === currentPrice);
      });
      applyFilters();
    });
  });

  // Render grid — initial batch
  function renderGrid() {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    displayedCount = 0;
    document.getElementById('nav-count').textContent = filtered.length;
    renderMore();
    document.querySelector('.footer').classList.add('visible');
  }

  // Append next batch of items
  function renderMore() {
    const grid = document.getElementById('grid');
    const end = Math.min(displayedCount + PAGE_SIZE, filtered.length);
    for (let i = displayedCount; i < end; i++) {
      const painting = filtered[i];
      const isLiked = likedIds.has(painting.id);
      const item = document.createElement('div');
      item.className = 'grid-item';
      item.style.animationDelay = `${Math.min((i - displayedCount) * 0.03, 1.2)}s`;
      item.onclick = () => openDetail(i, item);

      item.innerHTML = `
        <button class="grid-item-like${isLiked ? ' liked' : ''}" onclick="toggleGridLike(event, '${painting.id}')">${isLiked ? '&#9829;' : '&#9825;'}</button>
        <div class="grid-item-img-wrap">
          <img src="${painting.images[0]}" alt="${painting.title}" loading="lazy">
        </div>
        <div class="grid-item-title">${shortTitle(painting.title)}</div>
      `;
      grid.appendChild(item);
    }
    displayedCount = end;
  }

  // Populate detail view content (shared by open and switch)
  function populateDetail(index) {
    currentIndex = index;
    currentImageIndex = 0;
    const painting = filtered[index];

    const id = getPaintingId(painting);
    if (id) setHash(id);

    document.getElementById('detail-title').textContent = painting.title;
    document.getElementById('detail-price').textContent = painting.price
      ? `$${painting.price.toLocaleString()}`
      : 'INQUIRE';
    document.getElementById('detail-location').textContent = painting.location || '';
    document.getElementById('detail-link').href = painting.url || '#';

    // Art score + style
    const scoreEl = document.getElementById('detail-score');
    if (painting.art_score != null) {
      const topStyle = painting.clip_styles && painting.clip_styles[0] ? painting.clip_styles[0].style : '';
      scoreEl.textContent = `Art Score: ${painting.art_score.toFixed(1)}${topStyle ? ' \u00b7 ' + topStyle : ''}`;
    } else {
      scoreEl.textContent = '';
    }

    // Artist
    const artistEl = document.getElementById('detail-artist');
    if (painting.artist) {
      artistEl.textContent = painting.artist;
      artistEl.style.display = '';
    } else {
      artistEl.textContent = '';
      artistEl.style.display = 'none';
    }

    // Value score
    const valueEl = document.getElementById('detail-value');
    if (painting.value_score != null) {
      valueEl.textContent = `Value: ${painting.value_score.toFixed(1)}`;
      valueEl.style.display = '';
    } else {
      valueEl.textContent = '';
      valueEl.style.display = 'none';
    }

    // Reset expand
    document.getElementById('expand-btn').classList.remove('open');
    document.getElementById('detail-extra').classList.remove('open');

    // Set image
    const img = document.getElementById('detail-img');
    img.src = painting.images[0];
    img.alt = painting.title;

    renderDots(painting.images);

    // Arrows
    document.querySelector('.arrow-left').style.visibility = painting.images.length > 1 ? 'visible' : 'hidden';
    document.querySelector('.arrow-right').style.visibility = painting.images.length > 1 ? 'visible' : 'hidden';

    // Like button
    updateLikeButton();
  }

  // ─── FLIP OPEN ───
  function openDetail(index, clickedEl) {
    clearFlipTimeouts();
    populateDetail(index);

    const detail = document.getElementById('detail-view');
    const detailImg = document.getElementById('detail-img');
    const detailNav = detail.querySelector('.detail-nav');
    const detailInfo = detail.querySelector('.detail-info');

    // Reset all inline styles
    detail.style.cssText = '';
    detailImg.style.cssText = '';
    detailNav.style.cssText = '';
    detailInfo.style.cssText = '';

    // Get thumbnail rect
    let thumbRect = null;
    if (clickedEl) {
      const img = clickedEl.querySelector('.grid-item-img-wrap img');
      if (img) thumbRect = img.getBoundingClientRect();
    }

    // Dim grid
    document.getElementById('grid-view').classList.add('dimmed');
    document.getElementById('main-nav').classList.add('stv-nav--hidden');
    document.getElementById('price-filters').classList.add('stv-nav--hidden');
    if (window.stvMenuBtn) window.stvMenuBtn.classList.add('stv-menu-btn--hidden');
    document.getElementById('neighbor-nav').classList.add('active');

    if (thumbRect) {
      // FLIP path: transparent bg, image at thumbnail position
      detail.style.background = 'rgba(255, 255, 255, 0)';
      detail.style.opacity = '1';
      detailNav.style.opacity = '0';
      detailNav.style.transform = 'translateY(-20px)';
      detailInfo.style.opacity = '0';
      detailInfo.style.transform = 'translateY(20px)';
      detail.classList.add('active');

      requestAnimationFrame(() => {
        const finalRect = detailImg.getBoundingClientRect();

        if (finalRect.width > 0 && finalRect.height > 0) {
          // Invert: position image at thumbnail location
          const dx = (thumbRect.left + thumbRect.width / 2) - (finalRect.left + finalRect.width / 2);
          const dy = (thumbRect.top + thumbRect.height / 2) - (finalRect.top + finalRect.height / 2);
          const s = Math.min(thumbRect.width / finalRect.width, thumbRect.height / finalRect.height);

          detailImg.style.transition = 'none';
          detailImg.style.transform = `translate(${dx}px, ${dy}px) scale(${s})`;

          requestAnimationFrame(() => {
            // Play: animate to final position
            detail.style.transition = 'background 0.45s ease';
            detail.style.background = 'var(--white)';

            detailImg.style.transition = 'transform 0.55s cubic-bezier(0.34, 1.56, 0.64, 1)';
            detailImg.style.transform = 'none';

            // Stagger sub-elements
            flipTimeouts.push(setTimeout(() => {
              detailNav.style.transition = 'opacity 0.35s ease, transform 0.35s ease';
              detailNav.style.opacity = '1';
              detailNav.style.transform = 'none';
            }, 120));

            flipTimeouts.push(setTimeout(() => {
              detailInfo.style.transition = 'opacity 0.35s ease, transform 0.35s ease';
              detailInfo.style.opacity = '1';
              detailInfo.style.transform = 'none';
            }, 200));

            // Cleanup after animation
            flipTimeouts.push(setTimeout(() => {
              detail.style.cssText = '';
              detailImg.style.cssText = '';
              detailNav.style.cssText = '';
              detailInfo.style.cssText = '';
            }, 650));
          });
        } else {
          // Measurement failed — fallback
          detail.style.cssText = '';
          detailNav.style.cssText = '';
          detailInfo.style.cssText = '';
          fallbackOpen(detail);
        }
      });
    } else {
      // No FLIP source (permalink, keyboard)
      fallbackOpen(detail);
    }
  }

  function fallbackOpen(detail) {
    detail.style.opacity = '0';
    detail.style.transform = 'scale(1.04)';
    detail.classList.add('active');

    requestAnimationFrame(() => {
      detail.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
      detail.style.opacity = '1';
      detail.style.transform = 'scale(1)';

      flipTimeouts.push(setTimeout(() => {
        detail.style.cssText = '';
      }, 450));
    });
  }

  // ─── FLIP CLOSE ───
  function closeDetail() {
    clearFlipTimeouts();
    setHash(null);

    const detail = document.getElementById('detail-view');
    const detailImg = document.getElementById('detail-img');
    const detailNav = detail.querySelector('.detail-nav');
    const detailInfo = detail.querySelector('.detail-info');

    // Find target grid item to fly back to
    let targetRect = null;
    const gridItems = document.querySelectorAll('.grid-item');
    if (gridItems[currentIndex]) {
      const img = gridItems[currentIndex].querySelector('.grid-item-img-wrap img');
      if (img) {
        const rect = img.getBoundingClientRect();
        if (rect.width > 0) targetRect = rect;
      }
    }

    // Undim grid
    document.getElementById('grid-view').classList.remove('dimmed');
    document.getElementById('main-nav').classList.remove('stv-nav--hidden');
    document.getElementById('price-filters').classList.remove('stv-nav--hidden');
    if (window.stvMenuBtn) window.stvMenuBtn.classList.remove('stv-menu-btn--hidden');
    document.getElementById('neighbor-nav').classList.remove('active');

    if (targetRect) {
      const imgRect = detailImg.getBoundingClientRect();
      if (imgRect.width > 0) {
        const dx = (targetRect.left + targetRect.width / 2) - (imgRect.left + imgRect.width / 2);
        const dy = (targetRect.top + targetRect.height / 2) - (imgRect.top + imgRect.height / 2);
        const s = Math.min(targetRect.width / imgRect.width, targetRect.height / imgRect.height);

        // Hide sub-elements fast
        detailNav.style.transition = 'opacity 0.15s ease';
        detailNav.style.opacity = '0';
        detailInfo.style.transition = 'opacity 0.15s ease';
        detailInfo.style.opacity = '0';

        // Fly image back
        detailImg.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        detailImg.style.transform = `translate(${dx}px, ${dy}px) scale(${s})`;

        // Fade background
        detail.style.transition = 'background 0.35s ease';
        detail.style.background = 'rgba(255, 255, 255, 0)';

        flipTimeouts.push(setTimeout(() => {
          detail.classList.remove('active');
          detail.style.cssText = '';
          detailImg.style.cssText = '';
          detailNav.style.cssText = '';
          detailInfo.style.cssText = '';
        }, 450));
        return;
      }
    }

    // Fallback close
    detail.style.transition = 'opacity 0.35s ease, transform 0.35s ease';
    detail.style.opacity = '0';
    detail.style.transform = 'scale(1.04)';

    flipTimeouts.push(setTimeout(() => {
      detail.classList.remove('active');
      detail.style.cssText = '';
    }, 400));
  }

  // ─── SWITCH PAINTING (prev/next, no FLIP) ───
  function switchPainting(newIndex) {
    const img = document.getElementById('detail-img');
    img.classList.add('switching');

    setTimeout(() => {
      populateDetail(newIndex);
      document.querySelector('.detail-content').scrollTop = 0;
      img.classList.remove('switching');
    }, 200);
  }

  // Image carousel
  function renderDots(images) {
    const dots = document.getElementById('dots');
    dots.innerHTML = '';
    if (images.length <= 1) return;

    images.forEach((_, i) => {
      const dot = document.createElement('div');
      dot.className = `dot${i === currentImageIndex ? ' active' : ''}`;
      dot.onclick = () => goToImage(i);
      dots.appendChild(dot);
    });
  }

  function goToImage(index) {
    const painting = filtered[currentIndex];
    if (!painting) return;

    currentImageIndex = index;
    const img = document.getElementById('detail-img');

    img.classList.add('switching');
    setTimeout(() => {
      img.src = painting.images[index];
      img.classList.remove('switching');
    }, 200);

    document.querySelectorAll('.dot').forEach((d, i) => {
      d.classList.toggle('active', i === index);
    });
  }

  function nextImage() {
    const painting = filtered[currentIndex];
    if (!painting) return;
    const next = (currentImageIndex + 1) % painting.images.length;
    goToImage(next);
  }

  function prevImage() {
    const painting = filtered[currentIndex];
    if (!painting) return;
    const prev = (currentImageIndex - 1 + painting.images.length) % painting.images.length;
    goToImage(prev);
  }

  // Navigate between paintings
  function nextPainting() {
    if (currentIndex < filtered.length - 1) {
      switchPainting(currentIndex + 1);
    }
  }

  function prevPainting() {
    if (currentIndex > 0) {
      switchPainting(currentIndex - 1);
    }
  }

  // Expand extra info
  function toggleExtra() {
    document.getElementById('expand-btn').classList.toggle('open');
    document.getElementById('detail-extra').classList.toggle('open');
  }

  // Go home
  function goHome() {
    closeDetail();
    currentPrice = 'all';
    document.querySelectorAll('#price-filters button').forEach(b => {
      b.classList.toggle('active', b.dataset.price === 'all');
    });
    applyFilters();
    document.getElementById('grid-view').scrollTop = 0;
  }

  // Copy permalink
  function copyPermalink() {
    const painting = filtered[currentIndex];
    if (!painting) return;
    const id = getPaintingId(painting);
    const url = window.location.origin + window.location.pathname + '#' + id;
    navigator.clipboard.writeText(url).then(() => {
      const btn = document.getElementById('share-btn');
      btn.textContent = '\u2713';
      setTimeout(() => { btn.innerHTML = '&#8599;'; }, 1200);
    });
  }


  // Permalink
  function checkPermalink() {
    const hash = window.location.hash.slice(1);
    if (!hash) return;
    let idx = filtered.findIndex(p => getPaintingId(p) === hash);
    if (idx >= 0) {
      openDetail(idx);
      return;
    }
    const allIdx = findPaintingById(hash);
    if (allIdx >= 0) {
      currentPrice = 'all';
      document.querySelectorAll('#price-filters button').forEach(b => {
        b.classList.toggle('active', b.dataset.price === 'all');
      });
      filtered = [...paintings];
      renderGrid();
      idx = filtered.findIndex(p => getPaintingId(p) === hash);
      if (idx >= 0) openDetail(idx);
    }
  }

  // Browser back/forward
  window.addEventListener('popstate', () => {
    if (suppressHashChange) return;
    const hash = window.location.hash.slice(1);
    if (hash) {
      const idx = filtered.findIndex(p => getPaintingId(p) === hash);
      if (idx >= 0) {
        suppressHashChange = true;
        if (document.getElementById('detail-view').classList.contains('active')) {
          switchPainting(idx);
        } else {
          openDetail(idx);
        }
        suppressHashChange = false;
      }
    } else {
      const detail = document.getElementById('detail-view');
      if (detail.classList.contains('active')) {
        closeDetail();
      }
    }
  });

  // Infinite scroll
  document.getElementById('grid-view').addEventListener('scroll', () => {
    const el = document.getElementById('grid-view');
    if (displayedCount < filtered.length && el.scrollTop + el.clientHeight > el.scrollHeight - 600) {
      renderMore();
    }
  });

  // Keyboard nav
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (document.getElementById('detail-view').classList.contains('active')) {
        closeDetail();
      }
    }
    const detail = document.getElementById('detail-view');
    if (detail.classList.contains('active')) {
      if (e.key === 'ArrowLeft') prevImage();
      if (e.key === 'ArrowRight') nextImage();
      if (e.key === 'ArrowUp') prevPainting();
      if (e.key === 'ArrowDown') nextPainting();
      if (e.key === 'l' || e.key === 'L') toggleLike();
    }
  });

  // ─── LIKES (shared via Redis) ───

  function fetchLikes() {
    fetch('/api/like')
      .then(r => r.json())
      .then(data => {
        likedIds = new Set(data.liked || []);
        updateForYouVisibility();
      })
      .catch(() => {});
  }

  function toggleLike() {
    const painting = filtered[currentIndex];
    if (!painting) return;

    const isLiked = likedIds.has(painting.id);
    const newState = !isLiked;

    // Optimistic update
    if (newState) {
      likedIds.add(painting.id);
    } else {
      likedIds.delete(painting.id);
    }
    updateLikeButton();
    updateForYouVisibility();

    // Animate
    const btn = document.getElementById('like-btn');
    if (newState) {
      btn.classList.remove('pop');
      void btn.offsetWidth;
      btn.classList.add('pop');
    }

    // Persist to Redis
    fetch('/api/like', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: painting.id, liked: newState }),
    }).catch(() => {
      // Revert on failure
      if (newState) likedIds.delete(painting.id);
      else likedIds.add(painting.id);
      updateLikeButton();
    });
  }

  function toggleGridLike(e, paintingId) {
    e.stopPropagation();
    const isLiked = likedIds.has(paintingId);
    const newState = !isLiked;

    if (newState) likedIds.add(paintingId);
    else likedIds.delete(paintingId);

    // Update this grid heart
    const btn = e.currentTarget;
    btn.innerHTML = newState ? '&#9829;' : '&#9825;';
    btn.classList.toggle('liked', newState);
    updateForYouVisibility();

    fetch('/api/like', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: paintingId, liked: newState }),
    }).catch(() => {
      if (newState) likedIds.delete(paintingId);
      else likedIds.add(paintingId);
      btn.innerHTML = !newState ? '&#9829;' : '&#9825;';
      btn.classList.toggle('liked', !newState);
    });
  }

  function updateLikeButton() {
    const painting = filtered[currentIndex];
    const btn = document.getElementById('like-btn');
    if (!painting || !btn) return;
    const isLiked = likedIds.has(painting.id);
    btn.innerHTML = isLiked ? '&#9829;' : '&#9825;';
    btn.classList.toggle('liked', isLiked);
  }

  function updateForYouVisibility() {
    const btn = document.querySelector('[data-price="foryou"]');
    if (btn) {
      btn.style.display = likedIds.size > 0 ? '' : 'none';
    }
  }

  function fetchRecommendations() {
    fetch('/api/recommend', { signal: fetchController.signal })
      .then(r => r.json())
      .then(data => {
        if (data.message) {
          console.log('Recommendations:', data.message);
        }
        paintings = (data.paintings || []).filter(p => p.images && p.images.length > 0);
        filtered = [...paintings];
        document.getElementById('nav-count').textContent = filtered.length;
        renderGrid();
      })
      .catch(e => { if (e.name !== 'AbortError') console.error(e); });
  }

  // Load likes on startup
  fetchLikes();
</script>
<script src="stv-nav.js"></script>
</body>
</html>
