<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STEVENSON — Data</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --font: 'IBM Plex Mono', monospace;
    --bg: #0a0a0a;
    --fg: #d4d4d4;
    --bright: #fff;
    --dim: #555;
    --mute: #1e1e1e;
    --line: #1a1a1a;
    --green: #30d158;
    --blue: #5ac8fa;
    --orange: #ff9f0a;
    --pink: #ff375f;
    --purple: #bf5af2;
    --teal: #64d2ff;
  }

  html, body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--fg);
    -webkit-font-smoothing: antialiased;
    font-size: 11px;
  }

  ::-webkit-scrollbar { width: 0; }

  /* ─── TOPBAR ─── */
  .topbar {
    position: fixed;
    top: 0; left: 0; width: 100%;
    height: 40px;
    display: flex;
    align-items: center;
    padding: 0 16px;
    background: var(--bg);
    z-index: 100;
    border-bottom: 1px solid var(--mute);
  }

  .topbar a {
    color: var(--dim);
    text-decoration: none;
    font-size: 16px;
    transition: color 0.15s;
    line-height: 1;
  }
  .topbar a:hover { color: var(--bright); }

  .topbar-title {
    margin-left: 12px;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--dim);
  }

  .topbar-nav {
    margin-left: auto;
    display: flex;
    gap: 16px;
    font-size: 9px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .topbar-nav a {
    color: var(--dim);
    text-decoration: none;
    font-size: 9px;
    transition: color 0.15s;
  }
  .topbar-nav a:hover { color: var(--bright); }
  .topbar-nav a.active { color: var(--green); }

  .topbar-right {
    margin-left: 16px;
    font-size: 9px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--dim);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .topbar-right::before {
    content: '';
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s infinite;
  }

  @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

  /* ─── HERO ─── */
  .hero {
    margin-top: 40px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    border-bottom: 1px solid var(--mute);
  }

  .hero-stat {
    padding: 24px 20px;
    border-right: 1px solid var(--mute);
  }
  .hero-stat:last-child { border-right: none; }
  .hero-stat .num {
    font-size: 28px;
    font-weight: 600;
    color: var(--bright);
    line-height: 1;
  }
  .hero-stat .lbl {
    margin-top: 6px;
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--dim);
  }
  .hero-stat .sub {
    margin-top: 3px;
    font-size: 9px;
    color: #333;
  }

  /* ─── SECTION ─── */
  .sec-head {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--dim);
    padding: 20px 20px 10px;
    border-bottom: 1px solid var(--mute);
  }

  /* ─── PROGRESS ─── */
  .progress-section {
    padding: 20px;
    border-bottom: 1px solid var(--mute);
  }

  .progress-bar-wrap {
    position: relative;
    height: 28px;
    background: var(--mute);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--green);
    transition: width 0.6s ease;
    border-radius: 2px;
    position: relative;
  }

  .progress-bar-fill.scoring::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 40px;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15));
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-40px); }
    100% { transform: translateX(40px); }
  }

  .progress-bar-text {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 500;
    color: var(--bright);
    z-index: 1;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }

  .progress-meta {
    display: flex;
    justify-content: space-between;
    font-size: 9px;
    color: var(--dim);
  }

  /* ─── SOURCE CARDS ─── */
  .sources {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    border-bottom: 1px solid var(--mute);
  }

  .source-card {
    padding: 20px;
    border-right: 1px solid var(--mute);
  }
  .source-card:last-child { border-right: none; }

  .source-name {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--bright);
    margin-bottom: 12px;
  }

  .source-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
  }

  .source-row .k { color: var(--dim); }
  .source-row .v { color: var(--fg); font-weight: 500; }
  .source-row .v.green { color: var(--green); }
  .source-row .v.orange { color: var(--orange); }
  .source-row .v.blue { color: var(--blue); }

  .source-mini-bar {
    margin-top: 12px;
    height: 6px;
    background: var(--mute);
    border-radius: 2px;
    overflow: hidden;
  }

  .source-mini-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.6s ease;
  }

  /* ─── STATS GRID ─── */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    border-bottom: 1px solid var(--mute);
  }

  .stat-cell {
    padding: 16px 20px;
    border-right: 1px solid var(--mute);
  }
  .stat-cell:last-child { border-right: none; }

  .stat-cell .num {
    font-size: 20px;
    font-weight: 600;
    color: var(--bright);
    line-height: 1;
  }

  .stat-cell .lbl {
    margin-top: 4px;
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--dim);
  }

  /* ─── LOG ─── */
  .log-section {
    padding: 20px;
    border-bottom: 1px solid var(--mute);
  }

  .log {
    font-family: var(--font);
    font-size: 10px;
    line-height: 1.8;
    color: var(--dim);
    max-height: 280px;
    overflow-y: auto;
  }

  .log-line {
    display: flex;
    gap: 12px;
    padding: 2px 0;
    border-bottom: 1px solid #0d0d0d;
  }

  .log-ts { color: #333; white-space: nowrap; min-width: 60px; }
  .log-src { color: var(--blue); white-space: nowrap; min-width: 28px; text-transform: uppercase; }
  .log-msg { color: var(--dim); }
  .log-msg .n { color: var(--bright); font-weight: 500; }
  .log-msg .g { color: var(--green); }

  /* ─── FOOTER ─── */
  .foot {
    padding: 20px;
    font-size: 9px;
    color: #222;
    text-align: center;
    letter-spacing: 0.04em;
  }

  /* ─── RESPONSIVE ─── */
  @media (max-width: 600px) {
    .hero { grid-template-columns: repeat(2, 1fr); }
    .sources { grid-template-columns: 1fr; }
    .source-card { border-right: none; border-bottom: 1px solid var(--mute); }
    .stats-grid { grid-template-columns: 1fr; }
    .stat-cell { border-right: none; border-bottom: 1px solid var(--mute); }
  }
</style>
</head>
<body>

<div class="topbar">
  <a href="index.html">&#8249;</a>
  <span class="topbar-title">Data Pipeline</span>
  <div class="topbar-nav">
    <a href="analytics.html">Analytics</a>
    <a href="data.html" class="active">Data</a>
  </div>
  <span class="topbar-right" id="live-ct"></span>
</div>

<div class="hero" id="hero">
  <div class="hero-stat"><div class="num">--</div><div class="lbl">Total</div><div class="sub">loading</div></div>
  <div class="hero-stat"><div class="num">--</div><div class="lbl">Scored</div><div class="sub">loading</div></div>
  <div class="hero-stat"><div class="num">--</div><div class="lbl">Unscored</div><div class="sub">loading</div></div>
  <div class="hero-stat"><div class="num">--</div><div class="lbl">Coverage</div><div class="sub">loading</div></div>
</div>

<div class="sec-head">Scoring Progress</div>
<div class="progress-section" id="progress"></div>

<div class="sec-head">Sources</div>
<div class="sources" id="sources"></div>

<div class="sec-head">Pipeline Stats</div>
<div class="stats-grid" id="pipe-stats"></div>

<div class="sec-head">Activity Log</div>
<div class="log-section">
  <div class="log" id="log"></div>
</div>

<div class="foot">Stevenson / Data Pipeline / CLIP ViT-L/14 + LAION Aesthetic</div>

<script>
let prevScored = null;
let logEntries = [];

function fmt(n) { return n != null ? n.toLocaleString() : '--'; }

function render(d) {
  // Hero
  document.getElementById('hero').innerHTML = [
    { n: fmt(d.total_listings), l: 'Total Listings', s: d.sources.craigslist.total + d.sources.ebay.total + ' indexed' },
    { n: fmt(d.scored_count), l: 'Scored', s: 'CLIP + LAION' },
    { n: fmt(d.unscored_count), l: 'Unscored', s: 'awaiting scorer' },
    { n: d.score_pct + '%', l: 'Coverage', s: d.scored_count + '/' + d.total_listings },
  ].map(s => `<div class="hero-stat"><div class="num">${s.n}</div><div class="lbl">${s.l}</div><div class="sub">${s.s}</div></div>`).join('');

  // Progress bar
  const pct = d.score_pct;
  const isScoring = prevScored !== null && d.scored_count > prevScored;
  const scoringClass = isScoring || pct < 100 ? ' scoring' : '';
  document.getElementById('progress').innerHTML = `
    <div class="progress-bar-wrap">
      <div class="progress-bar-fill${scoringClass}" style="width:${pct}%;background:${pct >= 100 ? 'var(--green)' : pct > 50 ? 'var(--blue)' : 'var(--orange)'}"></div>
      <div class="progress-bar-text">${pct}% scored — ${fmt(d.scored_count)} of ${fmt(d.total_listings)}</div>
    </div>
    <div class="progress-meta">
      <span>${isScoring ? 'Scorer active — pushing live' : pct >= 100 ? 'All paintings scored' : 'Scorer idle'}</span>
      <span>Score range: ${d.score_min.toFixed(1)} – ${d.score_max.toFixed(1)} · Median: ${d.median_art_score.toFixed(1)}</span>
    </div>
  `;

  // Sources
  const cl = d.sources.craigslist;
  const eb = d.sources.ebay;
  const clPct = cl.total > 0 ? Math.round(cl.scored / cl.total * 100) : 0;
  const ebPct = eb.total > 0 ? Math.round(eb.scored / eb.total * 100) : 0;

  document.getElementById('sources').innerHTML = `
    <div class="source-card">
      <div class="source-name">Craigslist</div>
      <div class="source-row"><span class="k">Total</span><span class="v">${fmt(cl.total)}</span></div>
      <div class="source-row"><span class="k">Scored</span><span class="v green">${fmt(cl.scored)}</span></div>
      <div class="source-row"><span class="k">Unscored</span><span class="v orange">${fmt(cl.unscored)}</span></div>
      <div class="source-row"><span class="k">Coverage</span><span class="v blue">${clPct}%</span></div>
      <div class="source-mini-bar"><div class="source-mini-fill" style="width:${clPct}%;background:var(--green)"></div></div>
    </div>
    <div class="source-card">
      <div class="source-name">eBay</div>
      <div class="source-row"><span class="k">Total</span><span class="v">${fmt(eb.total)}</span></div>
      <div class="source-row"><span class="k">Scored</span><span class="v green">${fmt(eb.scored)}</span></div>
      <div class="source-row"><span class="k">Unscored</span><span class="v orange">${fmt(eb.unscored)}</span></div>
      <div class="source-row"><span class="k">Coverage</span><span class="v blue">${ebPct}%</span></div>
      <div class="source-mini-bar"><div class="source-mini-fill" style="width:${ebPct}%;background:var(--blue)"></div></div>
    </div>
  `;

  // Pipeline stats
  document.getElementById('pipe-stats').innerHTML = `
    <div class="stat-cell"><div class="num">${fmt(d.artists_count)}</div><div class="lbl">Artists Parsed</div></div>
    <div class="stat-cell"><div class="num">${fmt(d.top_rated_count)}</div><div class="lbl">Top Rated (55+)</div></div>
    <div class="stat-cell"><div class="num">${fmt(d.gems_count)}</div><div class="lbl">Gems (Value 8+)</div></div>
    <div class="stat-cell"><div class="num">${fmt(d.regions)}</div><div class="lbl">Regions</div></div>
    <div class="stat-cell"><div class="num">${fmt(d.dedup_count)}</div><div class="lbl">Dedup Set</div></div>
    <div class="stat-cell"><div class="num">$${d.price_median.toLocaleString()}</div><div class="lbl">Median Price</div></div>
  `;

  // Live indicator
  document.getElementById('live-ct').textContent = fmt(d.total_listings) + ' listings';

  // Activity log
  if (prevScored !== null && d.scored_count > prevScored) {
    const delta = d.scored_count - prevScored;
    const now = new Date();
    const ts = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
    logEntries.unshift({
      ts: ts,
      src: 'score',
      msg: `<span class="g">+${delta}</span> paintings scored — <span class="n">${fmt(d.scored_count)}</span> total (${d.score_pct}%)`
    });
    if (logEntries.length > 50) logEntries.length = 50;
  }

  renderLog();
  prevScored = d.scored_count;
}

function renderLog() {
  const el = document.getElementById('log');
  if (logEntries.length === 0) {
    el.innerHTML = '<div style="color:#333;padding:8px 0">Waiting for scorer activity...</div>';
    return;
  }
  el.innerHTML = logEntries.map(e =>
    `<div class="log-line"><span class="log-ts">${e.ts}</span><span class="log-src">${e.src}</span><span class="log-msg">${e.msg}</span></div>`
  ).join('');
}

function poll() {
  fetch('/api/pipeline')
    .then(r => r.json())
    .then(render)
    .catch(() => {});
}

// Initial + polling every 10s
poll();
setInterval(poll, 10000);
</script>
</body>
</html>
