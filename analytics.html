<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STEVENSON — Analytics</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --font: 'IBM Plex Mono', monospace;
    --bg: #0a0a0a;
    --fg: #e8e8e8;
    --dim: #444;
    --mute: #2a2a2a;
    --accent: #fff;
    --red: #ff3b30;
    --green: #30d158;
  }

  html, body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--fg);
    -webkit-font-smoothing: antialiased;
  }

  ::-webkit-scrollbar { width: 0; }

  /* ─── TOPBAR ─── */
  .topbar {
    position: fixed;
    top: 0; left: 0; width: 100%;
    height: 48px;
    display: flex;
    align-items: center;
    padding: 0 24px;
    background: var(--bg);
    z-index: 100;
    border-bottom: 1px solid var(--mute);
  }

  .topbar a {
    color: var(--dim);
    text-decoration: none;
    font-size: 18px;
    transition: color 0.15s;
  }

  .topbar a:hover { color: var(--fg); }

  .topbar-title {
    margin-left: 16px;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--dim);
  }

  .topbar-live {
    margin-left: auto;
    font-size: 9px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--dim);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .topbar-live::before {
    content: '';
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* ─── HERO STATS ─── */
  .hero {
    padding: 80px 24px 0;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    border-bottom: 1px solid var(--mute);
  }

  @media (max-width: 900px) { .hero { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 500px) { .hero { grid-template-columns: repeat(2, 1fr); } }

  .hero-stat {
    padding: 32px 24px 40px;
    border-right: 1px solid var(--mute);
  }

  .hero-stat:last-child { border-right: none; }

  .hero-stat .num {
    font-size: 48px;
    font-weight: 300;
    letter-spacing: -0.03em;
    line-height: 1;
    color: var(--accent);
  }

  .hero-stat .lbl {
    margin-top: 12px;
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--dim);
  }

  .hero-stat .sub {
    margin-top: 4px;
    font-size: 9px;
    color: var(--dim);
    letter-spacing: 0.02em;
  }

  /* ─── SECTIONS ─── */
  .section {
    border-bottom: 1px solid var(--mute);
  }

  .section-head {
    padding: 20px 24px;
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--dim);
    border-bottom: 1px solid var(--mute);
  }

  /* ─── CHART GRID ─── */
  .chart-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }

  @media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }

  .chart-cell {
    padding: 24px;
    border-right: 1px solid var(--mute);
    border-bottom: 1px solid var(--mute);
    position: relative;
  }

  .chart-cell:nth-child(2n) { border-right: none; }

  .chart-cell h3 {
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--dim);
    margin-bottom: 16px;
  }

  .chart-wrap {
    position: relative;
    height: 240px;
  }

  /* ─── WIDE CHART ─── */
  .chart-wide {
    padding: 24px;
    border-bottom: 1px solid var(--mute);
  }

  .chart-wide h3 {
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--dim);
    margin-bottom: 16px;
  }

  .chart-wide .chart-wrap { height: 200px; }

  /* ─── STRIP BARS (custom, no chart.js) ─── */
  .strip-bars {
    display: flex;
    flex-direction: column;
    gap: 3px;
    padding: 24px;
  }

  .strip-bar {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .strip-bar .bar-label {
    width: 90px;
    font-size: 9px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--dim);
    text-align: right;
    flex-shrink: 0;
  }

  .strip-bar .bar-track {
    flex: 1;
    height: 20px;
    background: var(--mute);
    position: relative;
  }

  .strip-bar .bar-fill {
    height: 100%;
    background: var(--fg);
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .strip-bar .bar-val {
    width: 48px;
    font-size: 10px;
    color: var(--dim);
    font-variant-numeric: tabular-nums;
  }

  /* ─── FILTER BAR ─── */
  .filter-bar {
    display: flex;
    gap: 0;
    padding: 0 24px;
    border-bottom: 1px solid var(--mute);
    overflow-x: auto;
  }

  .filter-bar button {
    font-family: var(--font);
    font-size: 9px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    background: none;
    border: none;
    border-right: 1px solid var(--mute);
    padding: 12px 16px;
    cursor: pointer;
    color: var(--dim);
    transition: all 0.15s;
    white-space: nowrap;
  }

  .filter-bar button:last-child { border-right: none; }

  .filter-bar button.active {
    background: var(--accent);
    color: var(--bg);
  }

  .filter-bar button:hover:not(.active) {
    color: var(--fg);
  }

  /* ─── TABLE ─── */
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
  }

  .data-table th {
    text-align: left;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 9px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--mute);
    color: var(--dim);
    cursor: pointer;
    user-select: none;
    transition: color 0.15s;
  }

  .data-table th:hover { color: var(--fg); }
  .data-table th.sorted { color: var(--accent); }

  .data-table td {
    padding: 8px 16px;
    border-bottom: 1px solid #151515;
    vertical-align: middle;
    color: var(--fg);
  }

  .data-table tr:hover td {
    background: #111;
  }

  .data-table .thumb {
    width: 36px; height: 36px;
    object-fit: cover;
  }

  .data-table .title-cell {
    max-width: 320px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .data-table a {
    color: var(--fg);
    text-decoration: none;
    transition: color 0.15s;
  }

  .data-table a:hover { color: var(--accent); }

  .tag {
    display: inline-block;
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 2px 5px;
    border: 1px solid var(--mute);
    margin-right: 3px;
    margin-bottom: 2px;
    color: var(--dim);
  }

  .tag.style { border-color: #333; color: var(--fg); }
  .tag.medium { border-color: #2a3a2a; color: #6a9a6a; }

  .score-pill {
    font-variant-numeric: tabular-nums;
    font-weight: 500;
  }

  .pagination {
    display: flex;
    gap: 0;
    justify-content: center;
    padding: 0;
    border-bottom: 1px solid var(--mute);
  }

  .pagination button {
    font-family: var(--font);
    font-size: 9px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    background: none;
    border: none;
    border-right: 1px solid var(--mute);
    border-left: 1px solid var(--mute);
    padding: 10px 20px;
    cursor: pointer;
    color: var(--dim);
    transition: all 0.15s;
  }

  .pagination button:hover:not(:disabled) { color: var(--accent); }
  .pagination button:disabled { opacity: 0.2; cursor: default; }

  .pagination .page-info {
    font-size: 9px;
    padding: 10px 16px;
    color: var(--dim);
    font-variant-numeric: tabular-nums;
  }

  /* ─── FOOTER ─── */
  .footer {
    padding: 40px 24px;
    text-align: center;
    font-size: 9px;
    color: var(--dim);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
</style>
</head>
<body>

<div class="topbar">
  <a href="index.html">&#8249;</a>
  <span class="topbar-title">Stevenson Analytics</span>
  <span class="topbar-live" id="live-count">1,393 listings</span>
</div>

<!-- HERO -->
<div class="hero" id="hero"></div>

<!-- CLIP ANALYSIS -->
<div class="section">
  <div class="section-head">CLIP Model Output</div>
  <div class="chart-grid">
    <div class="chart-cell">
      <h3>Art Score Distribution</h3>
      <div class="chart-wrap"><canvas id="chart-art-score"></canvas></div>
    </div>
    <div class="chart-cell">
      <h3>Quality vs Uniqueness</h3>
      <div class="chart-wrap"><canvas id="chart-quality-unique"></canvas></div>
    </div>
  </div>
  <div id="clip-style-strip"></div>
</div>

<!-- MARKET DATA -->
<div class="section">
  <div class="section-head">Market Data</div>
  <div class="chart-grid">
    <div class="chart-cell">
      <h3>Price Distribution</h3>
      <div class="chart-wrap"><canvas id="chart-price-dist"></canvas></div>
    </div>
    <div class="chart-cell">
      <h3>Avg Art Score by Region</h3>
      <div class="chart-wrap"><canvas id="chart-score-region"></canvas></div>
    </div>
  </div>
  <div id="region-strip"></div>
  <div id="medium-strip"></div>
</div>

<!-- EXPLORER -->
<div class="section">
  <div class="section-head">Explorer</div>
  <div class="filter-bar" id="explorer-filters">
    <button class="active" data-ef="all">All</button>
    <button data-ef="top-rated">Top Rated</button>
    <button data-ef="deals">Deals</button>
    <button data-ef="oil">Oil</button>
    <button data-ef="acrylic">Acrylic</button>
    <button data-ef="watercolor">Watercolor</button>
    <button data-ef="landscape">Landscape</button>
    <button data-ef="portrait">Portrait</button>
    <button data-ef="abstract-clip">Abstract</button>
    <button data-ef="signed">Signed</button>
  </div>
  <table class="data-table" id="explorer-table">
    <thead>
      <tr>
        <th></th>
        <th class="sorted" data-sort="title">Title</th>
        <th data-sort="price">Price</th>
        <th data-sort="region">Region</th>
        <th>Tags</th>
        <th data-sort="art_score">Score</th>
      </tr>
    </thead>
    <tbody id="explorer-body"></tbody>
  </table>
  <div class="pagination" id="pagination"></div>
</div>

<div class="footer">Stevenson &mdash; California Paintings Index &mdash; CLIP ViT-B/32</div>

<script>
const RL = {
  losangeles:'LA', sfbay:'SF Bay', sandiego:'SD', sacramento:'Sac',
  fresno:'Fresno', bakersfield:'Bako', orangecounty:'OC',
  inlandempire:'IE', ventura:'Ventura', santabarbara:'SB',
  stockton:'Stockton', modesto:'Modesto', visalia:'Visalia',
  merced:'Merced', monterey:'Monterey', chico:'Chico',
  redding:'Redding', humboldt:'Humboldt', mendocino:'Mendo',
  goldcountry:'Gold', susanville:'Susan', yubasutter:'Yuba',
  palmsprings:'PS', imperial:'Imperial', slo:'SLO',
  hanford:'Hanford', siskiyou:'Siskiyou',
};

// ─── NLP ───
const MEDIUMS = { oil:/\boil\b/i, acrylic:/\bacrylic\b/i, watercolor:/\bwater\s?colou?r\b/i, pastel:/\bpastel\b/i, gouache:/\bgouache\b/i, spray:/\bspray\b/i, ink:/\bink\b/i, mixed:/\bmixed\s?media\b/i, print:/\bprint\b|\blithograph\b|\bserigraph\b|\bgiclee\b/i };
const FLAGS = { signed:/\bsigned\b|\bsignature\b/i, framed:/\bframed\b|\bframe\b/i, large:/\blarge\b|\bhuge\b|\boversized\b|\b\d{2,3}\s*x\s*\d{2,3}\b/i, original:/\boriginal\b/i };

function classify(t) {
  const tags = { mediums:[], flags:[] };
  for (const [k,rx] of Object.entries(MEDIUMS)) if (rx.test(t)) tags.mediums.push(k);
  for (const [k,rx] of Object.entries(FLAGS)) if (rx.test(t)) tags.flags.push(k);
  return tags;
}

function computeDeals(items) {
  const g = {};
  for (const i of items) { const k = i.tags.mediums[0]||'x'; if(!g[k])g[k]=[]; if(i.price)g[k].push(i.price); }
  const m = {};
  for (const [k,p] of Object.entries(g)) { const s=p.sort((a,b)=>a-b); m[k]=s[Math.floor(s.length/2)]||100; }
  for (const i of items) {
    if(!i.price){i.dealScore=0;continue;}
    const k=i.tags.mediums[0]||'x', r=(m[k]-i.price)/m[k];
    let b=0; if(i.tags.flags.includes('signed'))b+=.15; if(i.tags.flags.includes('original'))b+=.15; if(i.tags.flags.includes('framed'))b+=.1;
    i.dealScore=Math.round(Math.min(100,Math.max(0,(r+b)*100)));
  }
}

// ─── CHART THEME ───
Chart.defaults.font.family = "'IBM Plex Mono', monospace";
Chart.defaults.font.size = 9;
Chart.defaults.color = '#444';
Chart.defaults.plugins.legend.display = false;
Chart.defaults.scales.linear = { ...Chart.defaults.scales.linear, grid: { color: '#1a1a1a' }, border: { color: '#2a2a2a' } };

// ─── DATA ───
let allItems = [], explorerItems = [], currentPage = 0, currentSort = { key:'art_score', dir:-1 };
const PAGE_SIZE = 30;

fetch('paintings.json').then(r=>r.json()).then(data => {
  allItems = data.filter(p=>p.images&&p.images.length>0).map(p=>({...p, tags:classify(p.title)}));
  computeDeals(allItems);
  document.getElementById('live-count').textContent = allItems.length.toLocaleString() + ' listings';
  renderHero();
  renderCharts();
  applyExplorerFilter('all');
});

// ─── HERO ───
function renderHero() {
  const pr = allItems.filter(p=>p.price).map(p=>p.price).sort((a,b)=>a-b);
  const sc = allItems.filter(p=>p.art_score!=null).map(p=>p.art_score).sort((a,b)=>a-b);
  const regions = new Set(allItems.map(p=>p.region));
  const top = allItems.filter(p=>p.art_score>=55);
  const med = pr.length ? pr[Math.floor(pr.length/2)] : 0;
  const medArt = sc.length ? sc[Math.floor(sc.length/2)] : 0;

  document.getElementById('hero').innerHTML = [
    { n: allItems.length.toLocaleString(), l:'Listings', s:'Across California' },
    { n: regions.size, l:'Regions', s:'Craigslist markets' },
    { n: '$'+med.toLocaleString(), l:'Median Price', s: '$'+Math.min(...pr).toLocaleString()+' — $'+Math.max(...pr).toLocaleString() },
    { n: medArt.toFixed(1), l:'Median Art Score', s: sc.length+' scored by CLIP' },
    { n: top.length, l:'Top Rated', s:'Score >= 55' },
  ].map(s=>`<div class="hero-stat"><div class="num">${s.n}</div><div class="lbl">${s.l}</div><div class="sub">${s.s}</div></div>`).join('');
}

// ─── CHARTS ───
function renderCharts() {
  chartArtScore();
  chartQualityUnique();
  renderClipStyleStrip();
  chartPriceDist();
  chartScoreRegion();
  renderRegionStrip();
  renderMediumStrip();
}

function chartArtScore() {
  const sc = allItems.filter(p=>p.art_score!=null);
  const bk = [35,40,45,50,55,60,65];
  const lb = ['<40','40-45','45-50','50-55','55-60','60+'];
  const c = new Array(6).fill(0);
  sc.forEach(p => {
    const s = p.art_score;
    if(s<40)c[0]++; else if(s<45)c[1]++; else if(s<50)c[2]++; else if(s<55)c[3]++; else if(s<60)c[4]++; else c[5]++;
  });
  new Chart(document.getElementById('chart-art-score'), {
    type:'bar',
    data:{ labels:lb, datasets:[{ data:c, backgroundColor:'#e8e8e8', hoverBackgroundColor:'#fff', borderRadius:0, barPercentage:0.85 }] },
    options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{grid:{display:false},border:{color:'#2a2a2a'}}, y:{grid:{color:'#1a1a1a'},border:{color:'#2a2a2a'}} } },
  });
}

function chartQualityUnique() {
  const d = allItems.filter(p=>p.quality_score!=null&&p.uniqueness!=null).map(p=>({x:p.quality_score,y:p.uniqueness}));
  new Chart(document.getElementById('chart-quality-unique'), {
    type:'scatter',
    data:{ datasets:[{ data:d, backgroundColor:'rgba(255,255,255,0.08)', borderColor:'rgba(255,255,255,0.2)', pointRadius:2.5, pointHoverRadius:5, pointHoverBackgroundColor:'#fff' }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{
        x:{ title:{display:true,text:'QUALITY',font:{size:8,weight:'500'},color:'#444'}, grid:{color:'#1a1a1a'}, border:{color:'#2a2a2a'} },
        y:{ title:{display:true,text:'UNIQUENESS',font:{size:8,weight:'500'},color:'#444'}, grid:{color:'#1a1a1a'}, border:{color:'#2a2a2a'} },
      },
    },
  });
}

function renderClipStyleStrip() {
  const counts = {};
  allItems.forEach(p => { if(!p.clip_styles||!p.clip_styles.length)return; counts[p.clip_styles[0].style]=(counts[p.clip_styles[0].style]||0)+1; });
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const max = sorted[0]?.[1]||1;
  const el = document.getElementById('clip-style-strip');
  el.innerHTML = '<div class="strip-bars">' + sorted.map(([name,count])=>`
    <div class="strip-bar">
      <span class="bar-label">${name}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${(count/max*100).toFixed(1)}%"></div></div>
      <span class="bar-val">${count}</span>
    </div>
  `).join('') + '</div>';
}

function chartPriceDist() {
  const bk=[0,25,50,100,200,500,1000,5000,Infinity];
  const lb=['<$25','$25-50','$50-100','$100-200','$200-500','$500-1K','$1K-5K','$5K+'];
  const c=new Array(8).fill(0);
  allItems.forEach(p=>{if(!p.price)return;for(let i=0;i<bk.length-1;i++){if(p.price>=bk[i]&&p.price<bk[i+1]){c[i]++;break;}}});
  new Chart(document.getElementById('chart-price-dist'),{
    type:'bar',
    data:{labels:lb,datasets:[{data:c,backgroundColor:'#e8e8e8',hoverBackgroundColor:'#fff',borderRadius:0,barPercentage:0.85}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false},border:{color:'#2a2a2a'}},y:{grid:{color:'#1a1a1a'},border:{color:'#2a2a2a'}}}},
  });
}

function chartScoreRegion() {
  const g={};
  allItems.forEach(p=>{if(p.art_score==null)return;if(!g[p.region])g[p.region]=[];g[p.region].push(p.art_score);});
  const entries=Object.entries(g).filter(([,s])=>s.length>=5).map(([r,s])=>[RL[r]||r,s.reduce((a,b)=>a+b,0)/s.length]).sort((a,b)=>b[1]-a[1]).slice(0,12);
  new Chart(document.getElementById('chart-score-region'),{
    type:'bar',
    data:{labels:entries.map(([r])=>r),datasets:[{data:entries.map(([,s])=>s),backgroundColor:'#e8e8e8',hoverBackgroundColor:'#fff',borderRadius:0,barPercentage:0.85}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false},border:{color:'#2a2a2a'}},y:{grid:{color:'#1a1a1a'},border:{color:'#2a2a2a'},min:45}}},
  });
}

function renderRegionStrip() {
  const counts={};
  allItems.forEach(p=>{counts[p.region]=(counts[p.region]||0)+1;});
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,12);
  const max=sorted[0]?.[1]||1;
  document.getElementById('region-strip').innerHTML='<div class="strip-bars">'+sorted.map(([r,c])=>`
    <div class="strip-bar">
      <span class="bar-label">${RL[r]||r}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${(c/max*100).toFixed(1)}%"></div></div>
      <span class="bar-val">${c}</span>
    </div>
  `).join('')+'</div>';
}

function renderMediumStrip() {
  const counts={};
  allItems.forEach(p=>{if(!p.tags.mediums.length)return;p.tags.mediums.forEach(m=>{counts[m]=(counts[m]||0)+1;});});
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const max=sorted[0]?.[1]||1;
  document.getElementById('medium-strip').innerHTML='<div class="strip-bars">'+sorted.map(([m,c])=>`
    <div class="strip-bar">
      <span class="bar-label">${m}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${(c/max*100).toFixed(1)}%"></div></div>
      <span class="bar-val">${c}</span>
    </div>
  `).join('')+'</div>';
}

// ─── EXPLORER ───
function applyExplorerFilter(f) {
  currentPage=0;
  document.querySelectorAll('#explorer-filters button').forEach(b=>b.classList.toggle('active',b.dataset.ef===f));
  switch(f){
    case 'top-rated': explorerItems=allItems.filter(p=>p.art_score>=50).sort((a,b)=>(b.art_score||0)-(a.art_score||0)); break;
    case 'deals': explorerItems=allItems.filter(p=>p.dealScore>=50).sort((a,b)=>b.dealScore-a.dealScore); break;
    case 'oil': explorerItems=allItems.filter(p=>p.tags.mediums.includes('oil')); break;
    case 'acrylic': explorerItems=allItems.filter(p=>p.tags.mediums.includes('acrylic')); break;
    case 'watercolor': explorerItems=allItems.filter(p=>p.tags.mediums.includes('watercolor')); break;
    case 'landscape': explorerItems=allItems.filter(p=>p.clip_styles&&p.clip_styles[0]&&p.clip_styles[0].style==='landscape'); break;
    case 'portrait': explorerItems=allItems.filter(p=>p.clip_styles&&p.clip_styles[0]&&p.clip_styles[0].style==='portrait'); break;
    case 'abstract-clip': explorerItems=allItems.filter(p=>p.clip_styles&&p.clip_styles[0]&&p.clip_styles[0].style==='abstract'); break;
    case 'signed': explorerItems=allItems.filter(p=>p.tags.flags.includes('signed')); break;
    default: explorerItems=[...allItems];
  }
  sortAndRender();
}

document.querySelectorAll('#explorer-filters button').forEach(b=>b.addEventListener('click',()=>applyExplorerFilter(b.dataset.ef)));

document.querySelectorAll('.data-table th[data-sort]').forEach(th=>{
  th.addEventListener('click',()=>{
    const k=th.dataset.sort;
    if(currentSort.key===k)currentSort.dir*=-1;else currentSort={key:k,dir:1};
    document.querySelectorAll('.data-table th').forEach(h=>h.classList.remove('sorted'));
    th.classList.add('sorted');
    currentPage=0;
    sortAndRender();
  });
});

function sortAndRender() {
  const {key,dir}=currentSort;
  explorerItems.sort((a,b)=>{
    let va,vb;
    switch(key){
      case 'price':va=a.price||0;vb=b.price||0;break;
      case 'art_score':va=a.art_score||0;vb=b.art_score||0;break;
      case 'region':va=a.region;vb=b.region;break;
      default:va=a.title.toLowerCase();vb=b.title.toLowerCase();
    }
    return va<vb?-dir:va>vb?dir:0;
  });
  renderTable();
}

function renderTable() {
  const start=currentPage*PAGE_SIZE;
  const page=explorerItems.slice(start,start+PAGE_SIZE);
  const body=document.getElementById('explorer-body');

  body.innerHTML=page.map(item=>{
    const tags=[
      ...item.tags.mediums.map(t=>`<span class="tag medium">${t}</span>`),
      ...(item.clip_styles||[]).slice(0,1).map(s=>`<span class="tag style">${s.style}</span>`),
      ...item.tags.flags.map(t=>`<span class="tag">${t}</span>`),
    ].join('');

    const s=item.art_score||0;
    const c=s>=55?'#fff':s>=50?'#888':s>=45?'#444':'#2a2a2a';

    return `<tr>
      <td><img class="thumb" src="${item.images[0]}" loading="lazy"></td>
      <td class="title-cell"><a href="${item.url}" target="_blank" rel="noopener">${item.title}</a></td>
      <td>${item.price?'$'+item.price.toLocaleString():'—'}</td>
      <td>${RL[item.region]||item.region}</td>
      <td>${tags||'—'}</td>
      <td class="score-pill" style="color:${c}">${s?s.toFixed(1):'—'}</td>
    </tr>`;
  }).join('');

  renderPagination();
}

function renderPagination() {
  const total=Math.ceil(explorerItems.length/PAGE_SIZE);
  const p=document.getElementById('pagination');
  if(total<=1){p.innerHTML='';return;}
  p.innerHTML=`
    <button ${currentPage===0?'disabled':''} onclick="currentPage--;renderTable()">Prev</button>
    <span class="page-info">${currentPage+1} / ${total} &mdash; ${explorerItems.length} items</span>
    <button ${currentPage>=total-1?'disabled':''} onclick="currentPage++;renderTable()">Next</button>
  `;
}
</script>
</body>
</html>
