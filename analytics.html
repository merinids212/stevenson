<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STEVENSON — Analytics</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --font: 'IBM Plex Mono', monospace;
    --bg: #0a0a0a;
    --fg: #d4d4d4;
    --bright: #fff;
    --dim: #555;
    --mute: #1e1e1e;
    --line: #1a1a1a;
    --green: #30d158;
    --blue: #5ac8fa;
    --orange: #ff9f0a;
    --pink: #ff375f;
    --purple: #bf5af2;
    --teal: #64d2ff;
  }

  html, body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--fg);
    -webkit-font-smoothing: antialiased;
    font-size: 11px;
  }

  ::-webkit-scrollbar { width: 0; }

  /* ─── TOPBAR ─── */
  .topbar {
    position: fixed;
    top: 0; left: 0; width: 100%;
    height: 40px;
    display: flex;
    align-items: center;
    padding: 0 16px;
    background: var(--bg);
    z-index: 100;
    border-bottom: 1px solid var(--mute);
  }

  .topbar a {
    color: var(--dim);
    text-decoration: none;
    font-size: 16px;
    transition: color 0.15s;
    line-height: 1;
  }
  .topbar a:hover { color: var(--bright); }

  .topbar-title {
    margin-left: 12px;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--dim);
  }

  .topbar-right {
    margin-left: auto;
    font-size: 9px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--dim);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .topbar-right::before {
    content: '';
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s infinite;
  }

  @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

  /* ─── HERO ─── */
  .hero {
    margin-top: 40px;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    border-bottom: 1px solid var(--mute);
  }

  .hero-stat {
    padding: 20px 16px;
    border-right: 1px solid var(--mute);
  }
  .hero-stat:last-child { border-right: none; }

  .hero-stat .num {
    font-size: 32px;
    font-weight: 300;
    letter-spacing: -0.02em;
    line-height: 1;
    color: var(--bright);
  }

  .hero-stat .lbl {
    margin-top: 6px;
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--dim);
  }

  .hero-stat .sub {
    margin-top: 2px;
    font-size: 8px;
    color: #333;
  }

  @media (max-width: 700px) {
    .hero { grid-template-columns: repeat(3, 1fr); }
    .hero-stat:nth-child(3) { border-right: none; }
    .hero-stat .num { font-size: 24px; }
  }

  @media (max-width: 420px) {
    .hero { grid-template-columns: repeat(2, 1fr); }
    .hero-stat:nth-child(2n) { border-right: none; }
    .hero-stat .num { font-size: 20px; }
    .hero-stat { padding: 14px 12px; }
  }

  /* ─── SECTION ─── */
  .sec-head {
    padding: 10px 16px;
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--dim);
    border-bottom: 1px solid var(--mute);
    background: #0d0d0d;
  }

  /* ─── CHART GRID ─── */
  .cgrid {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }

  .ccell {
    padding: 14px 16px;
    border-right: 1px solid var(--mute);
    border-bottom: 1px solid var(--mute);
  }
  .ccell:nth-child(2n) { border-right: none; }

  .ccell h3 {
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--dim);
    margin-bottom: 10px;
  }

  .cwrap { position: relative; height: 180px; }

  @media (max-width: 600px) {
    .cgrid { grid-template-columns: 1fr; }
    .ccell { border-right: none; }
    .cwrap { height: 150px; }
  }

  /* ─── STRIP BARS ─── */
  .strips {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border-bottom: 1px solid var(--mute);
  }

  .strip-col {
    padding: 12px 16px;
    border-right: 1px solid var(--mute);
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .strip-col:last-child { border-right: none; }

  .strip-col h4 {
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--dim);
    margin-bottom: 6px;
  }

  .sbar {
    display: flex;
    align-items: center;
    gap: 8px;
    height: 16px;
  }

  .sbar .sl {
    width: 72px;
    font-size: 9px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--dim);
    text-align: right;
    flex-shrink: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .sbar .st {
    flex: 1;
    height: 12px;
    background: var(--mute);
  }

  .sbar .sf {
    height: 100%;
    background: var(--fg);
    transition: width 0.5s ease;
  }

  .sbar .sv {
    width: 32px;
    font-size: 9px;
    color: #444;
    font-variant-numeric: tabular-nums;
  }

  @media (max-width: 600px) {
    .strips { grid-template-columns: 1fr; }
    .strip-col { border-right: none; border-bottom: 1px solid var(--mute); }
    .strip-col:last-child { border-bottom: none; }
    .sbar .sl { width: 60px; font-size: 8px; }
  }

  /* ─── FILTER BAR ─── */
  .fbar {
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--mute);
    -webkit-overflow-scrolling: touch;
  }

  .fbar button {
    font-family: var(--font);
    font-size: 9px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    background: none;
    border: none;
    border-right: 1px solid var(--mute);
    padding: 8px 12px;
    cursor: pointer;
    color: var(--dim);
    transition: all 0.12s;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .fbar button:last-child { border-right: none; }
  .fbar button.active { background: var(--bright); color: var(--bg); }
  .fbar button:hover:not(.active) { color: var(--fg); }

  /* ─── TABLE ─── */
  .tbl-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .dtbl {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
    min-width: 640px;
  }

  .dtbl th {
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: 8px;
    padding: 7px 10px;
    border-bottom: 1px solid var(--mute);
    color: var(--dim);
    cursor: pointer;
    user-select: none;
    transition: color 0.12s;
    position: sticky;
    top: 0;
    background: var(--bg);
  }
  .dtbl th:hover { color: var(--fg); }
  .dtbl th.sorted { color: var(--bright); }

  .dtbl td {
    padding: 5px 10px;
    border-bottom: 1px solid #111;
    vertical-align: middle;
  }

  .dtbl tr:hover td { background: #0f0f0f; }

  .dtbl .thumb {
    width: 32px; height: 32px;
    object-fit: cover;
    display: block;
  }

  .dtbl .tc {
    max-width: 280px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .dtbl a {
    color: var(--fg);
    text-decoration: none;
    transition: color 0.12s;
  }
  .dtbl a:hover { color: var(--bright); }

  .tag {
    display: inline-block;
    font-size: 7px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 1px 4px;
    border: 1px solid #222;
    margin: 0 2px 1px 0;
    color: #555;
  }
  .tag.style { border-color: #333; color: var(--fg); }
  .tag.medium { border-color: #1e2e1e; color: #5a8a5a; }

  .sc {
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    font-size: 11px;
  }

  /* ─── EXPLORER HUNTER MODE ─── */
  .explorer-wrap {
    position: relative;
  }

  .explorer-wrap .fbar {
    position: sticky;
    top: 40px;
    z-index: 50;
    background: var(--bg);
  }

  .explorer-count {
    padding: 6px 16px;
    font-size: 8px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #333;
    border-bottom: 1px solid var(--mute);
    background: #0d0d0d;
  }

  .dtbl .thumb {
    width: 44px; height: 44px;
    object-fit: cover;
    display: block;
    border: 1px solid #1a1a1a;
    transition: border-color 0.15s;
  }

  .dtbl tr:hover .thumb { border-color: #333; }

  /* ─── PAGINATION ─── */
  .pag {
    display: flex;
    justify-content: center;
    border-bottom: 1px solid var(--mute);
  }

  .pag button {
    font-family: var(--font);
    font-size: 9px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    background: none; border: none;
    border-left: 1px solid var(--mute);
    border-right: 1px solid var(--mute);
    padding: 7px 16px;
    cursor: pointer;
    color: var(--dim);
    transition: color 0.12s;
  }
  .pag button:hover:not(:disabled) { color: var(--bright); }
  .pag button:disabled { opacity: 0.15; cursor: default; }

  .pag .pi {
    font-size: 8px;
    padding: 7px 12px;
    color: #333;
    font-variant-numeric: tabular-nums;
  }

  .foot {
    padding: 24px 16px;
    text-align: center;
    font-size: 8px;
    color: #222;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
</style>
</head>
<body>

<div class="topbar">
  <a href="index.html">&#8249;</a>
  <span class="topbar-title">Analytics</span>
  <span class="topbar-right" id="live-ct"></span>
</div>

<div class="hero" id="hero"></div>

<!-- CLIP -->
<div class="sec-head">CLIP Model</div>
<div class="cgrid">
  <div class="ccell">
    <h3>Art Score Distribution</h3>
    <div class="cwrap"><canvas id="c-art"></canvas></div>
  </div>
  <div class="ccell">
    <h3>Quality vs Uniqueness</h3>
    <div class="cwrap"><canvas id="c-qu"></canvas></div>
  </div>
</div>
<div class="strips" id="clip-strips"></div>

<!-- MARKET -->
<div class="sec-head">Market</div>
<div class="cgrid">
  <div class="ccell">
    <h3>Price Distribution</h3>
    <div class="cwrap"><canvas id="c-price"></canvas></div>
  </div>
  <div class="ccell">
    <h3>Art Score by Region</h3>
    <div class="cwrap"><canvas id="c-sreg"></canvas></div>
  </div>
</div>
<div class="strips" id="mkt-strips"></div>

<!-- EXPLORER -->
<div class="explorer-wrap">
  <div class="sec-head">Hunter</div>
  <div class="fbar" id="fbar">
    <button class="active" data-ef="all">All</button>
    <button data-ef="top-rated">Top</button>
    <button data-ef="deals">Deals</button>
    <button data-ef="oil">Oil</button>
    <button data-ef="acrylic">Acrylic</button>
    <button data-ef="watercolor">Watercolor</button>
    <button data-ef="landscape">Landscape</button>
    <button data-ef="portrait">Portrait</button>
    <button data-ef="abstract-clip">Abstract</button>
    <button data-ef="signed">Signed</button>
  </div>
  <div class="explorer-count" id="exp-count"></div>
  <div class="tbl-wrap">
    <table class="dtbl" id="dtbl">
      <thead>
        <tr>
          <th style="width:50px"></th>
          <th data-sort="title">Title</th>
          <th data-sort="price" style="width:72px">Price</th>
          <th data-sort="region" style="width:60px">Region</th>
          <th style="width:150px">Tags</th>
          <th data-sort="art_score" class="sorted" style="width:52px">Score</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="pag" id="pag"></div>
</div>

<div class="foot">Stevenson / California Paintings / CLIP ViT-B/32</div>

<script>
const RL={losangeles:'LA',sfbay:'SF',sandiego:'SD',sacramento:'Sac',fresno:'Fres',bakersfield:'Bako',orangecounty:'OC',inlandempire:'IE',ventura:'Vent',santabarbara:'SB',stockton:'Stock',modesto:'Mod',visalia:'Vis',merced:'Merc',monterey:'Mont',chico:'Chico',redding:'Red',humboldt:'Hum',mendocino:'Mendo',goldcountry:'Gold',susanville:'Susan',yubasutter:'Yuba',palmsprings:'PS',imperial:'Imp',slo:'SLO',hanford:'Han',siskiyou:'Sisk'};
const MEDIUMS={oil:/\boil\b/i,acrylic:/\bacrylic\b/i,watercolor:/\bwater\s?colou?r\b/i,pastel:/\bpastel\b/i,gouache:/\bgouache\b/i,spray:/\bspray\b/i,ink:/\bink\b/i,mixed:/\bmixed\s?media\b/i,print:/\bprint\b|\blithograph\b|\bserigraph\b|\bgiclee\b/i};
const FLAGS={signed:/\bsigned\b|\bsignature\b/i,framed:/\bframed\b|\bframe\b/i,large:/\blarge\b|\bhuge\b|\boversized\b|\b\d{2,3}\s*x\s*\d{2,3}\b/i,original:/\boriginal\b/i};

function classify(t){const r={mediums:[],flags:[]};for(const[k,x]of Object.entries(MEDIUMS))if(x.test(t))r.mediums.push(k);for(const[k,x]of Object.entries(FLAGS))if(x.test(t))r.flags.push(k);return r;}
function deals(items){const g={};for(const i of items){const k=i.tags.mediums[0]||'x';if(!g[k])g[k]=[];if(i.price)g[k].push(i.price);}const m={};for(const[k,p]of Object.entries(g)){const s=p.sort((a,b)=>a-b);m[k]=s[Math.floor(s.length/2)]||100;}for(const i of items){if(!i.price){i.ds=0;continue;}const k=i.tags.mediums[0]||'x',r=(m[k]-i.price)/m[k];let b=0;if(i.tags.flags.includes('signed'))b+=.15;if(i.tags.flags.includes('original'))b+=.15;if(i.tags.flags.includes('framed'))b+=.1;i.ds=Math.round(Math.min(100,Math.max(0,(r+b)*100)));}}

Chart.defaults.font.family="'IBM Plex Mono',monospace";
Chart.defaults.font.size=8;
Chart.defaults.color='#333';
Chart.defaults.plugins.legend.display=false;

let all=[],exp=[],pg=0,sort={key:'art_score',dir:-1};
const PS=40;

fetch('paintings.json').then(r=>r.json()).then(d=>{
  all=d.filter(p=>p.images&&p.images.length>0).map(p=>({...p,tags:classify(p.title)}));
  deals(all);
  document.getElementById('live-ct').textContent=all.length.toLocaleString()+' listings';
  hero();charts();filter('all');
});

function hero(){
  const pr=all.filter(p=>p.price).map(p=>p.price).sort((a,b)=>a-b);
  const sc=all.filter(p=>p.art_score!=null).map(p=>p.art_score).sort((a,b)=>a-b);
  const rg=new Set(all.map(p=>p.region));
  const tp=all.filter(p=>p.art_score>=55);
  const md=pr.length?pr[Math.floor(pr.length/2)]:0;
  const ma=sc.length?sc[Math.floor(sc.length/2)]:0;
  document.getElementById('hero').innerHTML=[
    {n:all.length.toLocaleString(),l:'Listings',s:'California'},
    {n:rg.size,l:'Regions',s:'CL markets'},
    {n:'$'+md.toLocaleString(),l:'Med. Price',s:'$'+Math.min(...pr)+'–$'+Math.max(...pr).toLocaleString()},
    {n:ma.toFixed(1),l:'Art Score',s:sc.length+' CLIP scored'},
    {n:tp.length,l:'Top Rated',s:'Score 55+'},
  ].map(s=>`<div class="hero-stat"><div class="num">${s.n}</div><div class="lbl">${s.l}</div><div class="sub">${s.s}</div></div>`).join('');
}

function charts(){
  // Art score dist — gradient from dim to bright
  const sc=all.filter(p=>p.art_score!=null);
  const cn=new Array(6).fill(0);
  sc.forEach(p=>{const s=p.art_score;if(s<40)cn[0]++;else if(s<45)cn[1]++;else if(s<50)cn[2]++;else if(s<55)cn[3]++;else if(s<60)cn[4]++;else cn[5]++;});
  new Chart(document.getElementById('c-art'),{
    type:'bar',
    data:{labels:['<40','40–45','45–50','50–55','55–60','60+'],datasets:[{data:cn,backgroundColor:['#332222','#553322','#886633','#aa8844','#ccbb55','#30d158'],borderRadius:0,barPercentage:0.8}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false},border:{color:'#1e1e1e'}},y:{grid:{color:'#151515'},border:{color:'#1e1e1e'}}}},
  });

  // Q vs U scatter — color by art score
  const sf=all.filter(p=>p.quality_score!=null&&p.uniqueness!=null);
  const sMin=Math.min(...sf.map(p=>p.art_score||0)),sMax=Math.max(...sf.map(p=>p.art_score||0));
  const sd=sf.map(p=>({x:p.quality_score,y:p.uniqueness}));
  const sColors=sf.map(p=>{const t=((p.art_score||0)-sMin)/(sMax-sMin||1);return `hsla(${Math.round(t*120)},70%,50%,0.25)`;});
  const sBorders=sf.map(p=>{const t=((p.art_score||0)-sMin)/(sMax-sMin||1);return `hsla(${Math.round(t*120)},70%,50%,0.5)`;});
  new Chart(document.getElementById('c-qu'),{
    type:'scatter',
    data:{datasets:[{data:sd,backgroundColor:sColors,borderColor:sBorders,pointRadius:2.5,pointHoverRadius:5,pointHoverBackgroundColor:'#fff'}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:'QUALITY',font:{size:7,weight:'600'},color:'#444'},grid:{color:'#151515'},border:{color:'#1e1e1e'}},y:{title:{display:true,text:'UNIQUENESS',font:{size:7,weight:'600'},color:'#444'},grid:{color:'#151515'},border:{color:'#1e1e1e'}}}},
  });

  // Price dist — blue gradient
  const bk=[0,25,50,100,200,500,1000,5000,Infinity],lb=['<25','25','50','100','200','500','1K','5K+'],pc=new Array(8).fill(0);
  all.forEach(p=>{if(!p.price)return;for(let i=0;i<bk.length-1;i++){if(p.price>=bk[i]&&p.price<bk[i+1]){pc[i]++;break;}}});
  new Chart(document.getElementById('c-price'),{
    type:'bar',
    data:{labels:lb,datasets:[{data:pc,backgroundColor:['#1a3344','#1e4455','#225566','#266677','#2a7788','#2e8899','#339aaa','#38abbb'],borderRadius:0,barPercentage:0.8}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false},border:{color:'#1e1e1e'}},y:{grid:{color:'#151515'},border:{color:'#1e1e1e'}}}},
  });

  // Score by region
  const rg={};
  all.forEach(p=>{if(p.art_score==null)return;if(!rg[p.region])rg[p.region]=[];rg[p.region].push(p.art_score);});
  const re=Object.entries(rg).filter(([,s])=>s.length>=5).map(([r,s])=>[RL[r]||r,s.reduce((a,b)=>a+b,0)/s.length]).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const regColors=re.map(([,s])=>{const t=(s-46)/(52-46);return `hsl(${30+t*20},${50+t*30}%,${35+t*25}%)`;});
  new Chart(document.getElementById('c-sreg'),{
    type:'bar',
    data:{labels:re.map(([r])=>r),datasets:[{data:re.map(([,s])=>s),backgroundColor:regColors,hoverBackgroundColor:'#fff',borderRadius:0,barPercentage:0.8}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false},border:{color:'#1e1e1e'}},y:{grid:{color:'#151515'},border:{color:'#1e1e1e'},min:46}}},
  });

  // Strips
  renderStrips();
}

function mkStrip(items,max,hue){
  return items.map(([n,c],i)=>{
    const pct=(c/max*100).toFixed(1);
    const light=35+((c/max)*20);
    const col=`hsl(${hue},50%,${light}%)`;
    return `<div class="sbar"><span class="sl">${n}</span><div class="st"><div class="sf" style="width:${pct}%;background:${col}"></div></div><span class="sv">${c}</span></div>`;
  }).join('');
}

function renderStrips(){
  // CLIP styles + mediums side by side
  const stc={};
  all.forEach(p=>{if(!p.clip_styles||!p.clip_styles.length)return;stc[p.clip_styles[0].style]=(stc[p.clip_styles[0].style]||0)+1;});
  const sts=Object.entries(stc).sort((a,b)=>b[1]-a[1]);

  const mdc={};
  all.forEach(p=>{p.tags.mediums.forEach(m=>{mdc[m]=(mdc[m]||0)+1;});});
  const mds=Object.entries(mdc).sort((a,b)=>b[1]-a[1]);

  document.getElementById('clip-strips').innerHTML=
    `<div class="strip-col"><h4>CLIP Styles</h4>${mkStrip(sts,sts[0]?.[1]||1,270)}</div>`+
    `<div class="strip-col"><h4>Mediums (NLP)</h4>${mkStrip(mds,mds[0]?.[1]||1,140)}</div>`;

  // Regions + price ranges side by side
  const rgc={};
  all.forEach(p=>{rgc[p.region]=(rgc[p.region]||0)+1;});
  const rgs=Object.entries(rgc).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([r,c])=>[RL[r]||r,c]);

  const prc={'<$50':0,'$50–200':0,'$200–1K':0,'$1K+':0};
  all.forEach(p=>{if(!p.price)return;if(p.price<50)prc['<$50']++;else if(p.price<=200)prc['$50–200']++;else if(p.price<=1000)prc['$200–1K']++;else prc['$1K+']++;});
  const prs=Object.entries(prc);

  document.getElementById('mkt-strips').innerHTML=
    `<div class="strip-col"><h4>Regions</h4>${mkStrip(rgs,rgs[0]?.[1]||1,200)}</div>`+
    `<div class="strip-col"><h4>Price Bands</h4>${mkStrip(prs,Math.max(...prs.map(([,c])=>c))||1,35)}</div>`;
}

// ─── EXPLORER ───
function filter(f){
  pg=0;
  document.querySelectorAll('#fbar button').forEach(b=>b.classList.toggle('active',b.dataset.ef===f));
  switch(f){
    case 'top-rated':exp=all.filter(p=>p.art_score>=50).sort((a,b)=>(b.art_score||0)-(a.art_score||0));break;
    case 'deals':exp=all.filter(p=>p.ds>=50).sort((a,b)=>b.ds-a.ds);break;
    case 'oil':exp=all.filter(p=>p.tags.mediums.includes('oil'));break;
    case 'acrylic':exp=all.filter(p=>p.tags.mediums.includes('acrylic'));break;
    case 'watercolor':exp=all.filter(p=>p.tags.mediums.includes('watercolor'));break;
    case 'landscape':exp=all.filter(p=>p.clip_styles&&p.clip_styles[0]&&p.clip_styles[0].style==='landscape');break;
    case 'portrait':exp=all.filter(p=>p.clip_styles&&p.clip_styles[0]&&p.clip_styles[0].style==='portrait');break;
    case 'abstract-clip':exp=all.filter(p=>p.clip_styles&&p.clip_styles[0]&&p.clip_styles[0].style==='abstract');break;
    case 'signed':exp=all.filter(p=>p.tags.flags.includes('signed'));break;
    default:exp=[...all];
  }
  doSort();
}

document.querySelectorAll('#fbar button').forEach(b=>b.addEventListener('click',()=>filter(b.dataset.ef)));

document.querySelectorAll('.dtbl th[data-sort]').forEach(th=>{
  th.addEventListener('click',()=>{
    const k=th.dataset.sort;
    if(sort.key===k)sort.dir*=-1;else sort={key:k,dir:1};
    document.querySelectorAll('.dtbl th').forEach(h=>h.classList.remove('sorted'));
    th.classList.add('sorted');
    pg=0;doSort();
  });
});

function doSort(){
  const{key,dir}=sort;
  exp.sort((a,b)=>{let va,vb;switch(key){case'price':va=a.price||0;vb=b.price||0;break;case'art_score':va=a.art_score||0;vb=b.art_score||0;break;case'region':va=a.region;vb=b.region;break;default:va=a.title.toLowerCase();vb=b.title.toLowerCase();}return va<vb?-dir:va>vb?dir:0;});
  tbl();
}

function tbl(){
  const s=pg*PS,p=exp.slice(s,s+PS),body=document.getElementById('tbody');
  document.getElementById('exp-count').textContent=exp.length+' results \u00b7 page '+(pg+1)+'/'+Math.ceil(exp.length/PS);
  body.innerHTML=p.map(i=>{
    const tags=[...i.tags.mediums.map(t=>`<span class="tag medium">${t}</span>`),...(i.clip_styles||[]).slice(0,1).map(s=>`<span class="tag style">${s.style}</span>`),...i.tags.flags.map(t=>`<span class="tag">${t}</span>`)].join('');
    const v=i.art_score||0;
    const t=Math.max(0,Math.min(1,(v-38)/(60-38)));
    const h=Math.round(t*120);
    const c=v>=55?`hsl(${h},70%,55%)`:v>=50?`hsl(${h},50%,45%)`:v>=45?`hsl(${h},30%,35%)`:'#222';
    return `<tr><td><img class="thumb" src="${i.images[0]}" loading="lazy"></td><td class="tc"><a href="${i.url}" target="_blank" rel="noopener">${i.title}</a></td><td>${i.price?'$'+i.price.toLocaleString():'—'}</td><td>${RL[i.region]||i.region}</td><td>${tags||'—'}</td><td class="sc" style="color:${c}">${v?v.toFixed(1):'—'}</td></tr>`;
  }).join('');
  pagi();
}

function pagi(){
  const t=Math.ceil(exp.length/PS),el=document.getElementById('pag');
  if(t<=1){el.innerHTML='';return;}
  el.innerHTML=`<button ${pg===0?'disabled':''} onclick="pg--;tbl()">Prev</button><span class="pi">${pg+1}/${t} &middot; ${exp.length}</span><button ${pg>=t-1?'disabled':''} onclick="pg++;tbl()">Next</button>`;
}
</script>
</body>
</html>
