<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>STEVENSON — Analytics</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="stv-nav.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --font: 'IBM Plex Mono', monospace;
    --bg: #0a0a0a;
    --fg: #d4d4d4;
    --bright: #fff;
    --dim: #555;
    --mute: #1e1e1e;
    --line: #1a1a1a;
    --green: #30d158;
    --blue: #5ac8fa;
    --orange: #ff9f0a;
    --pink: #ff375f;
    --purple: #bf5af2;
    --teal: #64d2ff;
  }

  html, body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--fg);
    -webkit-font-smoothing: antialiased;
    font-size: 11px;
  }

  ::-webkit-scrollbar { width: 0; }

  /* ─── HERO ─── */
  .hero {
    margin-top: calc(48px + env(safe-area-inset-top, 0px));
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    border-bottom: 1px solid var(--mute);
  }

  .hero-stat {
    padding: 20px 16px;
    border-right: 1px solid var(--mute);
  }
  .hero-stat:last-child { border-right: none; }

  .hero-stat .num {
    font-size: 32px;
    font-weight: 300;
    letter-spacing: -0.02em;
    line-height: 1;
    color: var(--bright);
  }

  .hero-stat .lbl {
    margin-top: 6px;
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--dim);
  }

  .hero-stat .sub {
    margin-top: 2px;
    font-size: 8px;
    color: #333;
  }

  @media (max-width: 700px) {
    .hero { grid-template-columns: repeat(3, 1fr); }
    .hero-stat:nth-child(3) { border-right: none; }
    .hero-stat .num { font-size: 24px; }
  }

  @media (max-width: 420px) {
    .hero { grid-template-columns: repeat(2, 1fr); }
    .hero-stat:nth-child(2n) { border-right: none; }
    .hero-stat .num { font-size: 20px; }
    .hero-stat { padding: 14px 12px; }
  }

  /* ─── SECTION ─── */
  .sec-head {
    padding: 10px 16px;
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--dim);
    border-bottom: 1px solid var(--mute);
    background: #0d0d0d;
  }

  /* ─── CHART GRID ─── */
  .cgrid {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }

  .ccell {
    padding: 14px 16px;
    border-right: 1px solid var(--mute);
    border-bottom: 1px solid var(--mute);
  }
  .ccell:nth-child(2n) { border-right: none; }

  .ccell h3 {
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--dim);
    margin-bottom: 10px;
  }

  .cwrap { position: relative; height: 180px; }

  @media (max-width: 600px) {
    .cgrid { grid-template-columns: 1fr; }
    .ccell { border-right: none; }
    .cwrap { height: 150px; }
  }

  /* ─── STRIP BARS ─── */
  .strips {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border-bottom: 1px solid var(--mute);
  }

  .strip-col {
    padding: 12px 16px;
    border-right: 1px solid var(--mute);
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .strip-col:last-child { border-right: none; }

  .strip-col h4 {
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--dim);
    margin-bottom: 6px;
  }

  .sbar {
    display: flex;
    align-items: center;
    gap: 8px;
    height: 16px;
  }

  .sbar .sl {
    width: 72px;
    font-size: 9px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--dim);
    text-align: right;
    flex-shrink: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .sbar .st {
    flex: 1;
    height: 12px;
    background: var(--mute);
  }

  .sbar .sf {
    height: 100%;
    background: var(--fg);
    transition: width 0.5s ease;
  }

  .sbar .sv {
    width: 32px;
    font-size: 9px;
    color: #444;
    font-variant-numeric: tabular-nums;
  }

  @media (max-width: 600px) {
    .strips { grid-template-columns: 1fr; }
    .strip-col { border-right: none; border-bottom: 1px solid var(--mute); }
    .strip-col:last-child { border-bottom: none; }
    .sbar .sl { width: 60px; font-size: 8px; }
  }

  /* ─── FILTER BAR ─── */
  .fbar {
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--mute);
    -webkit-overflow-scrolling: touch;
  }

  .fbar button {
    font-family: var(--font);
    font-size: 9px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    background: none;
    border: none;
    border-right: 1px solid var(--mute);
    padding: 8px 12px;
    cursor: pointer;
    color: var(--dim);
    transition: all 0.12s;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .fbar button:last-child { border-right: none; }
  .fbar button.active { background: var(--bright); color: var(--bg); }
  .fbar button:hover:not(.active) { color: var(--fg); }

  /* ─── TABLE ─── */
  .tbl-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .dtbl {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
    min-width: 720px;
  }

  .dtbl th {
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: 8px;
    padding: 7px 10px;
    border-bottom: 1px solid var(--mute);
    color: var(--dim);
    cursor: pointer;
    user-select: none;
    transition: color 0.12s;
    position: sticky;
    top: 0;
    background: var(--bg);
  }
  .dtbl th:hover { color: var(--fg); }
  .dtbl th.sorted { color: var(--bright); }

  .dtbl td {
    padding: 5px 10px;
    border-bottom: 1px solid #111;
    vertical-align: middle;
  }

  .dtbl tr:hover td { background: #0f0f0f; }

  .dtbl .thumb {
    width: 44px; height: 44px;
    object-fit: cover;
    display: block;
    border: 1px solid #1a1a1a;
    transition: border-color 0.15s;
  }

  .dtbl tr:hover .thumb { border-color: #333; }

  .dtbl .tc {
    max-width: 240px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .dtbl a {
    color: var(--fg);
    text-decoration: none;
    transition: color 0.12s;
  }
  .dtbl a:hover { color: var(--bright); }

  .tag {
    display: inline-block;
    font-size: 7px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 1px 4px;
    border: 1px solid #222;
    margin: 0 2px 1px 0;
    color: #555;
  }
  .tag.style { border-color: #333; color: var(--fg); }
  .tag.medium { border-color: #1e2e1e; color: #5a8a5a; }
  .tag.artist { border-color: #2e2e1e; color: #b8a060; }

  .sc {
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    font-size: 11px;
  }

  /* ─── EXPLORER ─── */
  .explorer-wrap {
    position: relative;
  }

  .explorer-wrap .fbar {
    position: sticky;
    top: calc(48px + env(safe-area-inset-top, 0px));
    z-index: 50;
    background: var(--bg);
  }

  .explorer-count {
    padding: 6px 16px;
    font-size: 8px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #333;
    border-bottom: 1px solid var(--mute);
    background: #0d0d0d;
  }

  /* ─── PAGINATION ─── */
  .pag {
    display: flex;
    justify-content: center;
    border-bottom: 1px solid var(--mute);
  }

  .pag button {
    font-family: var(--font);
    font-size: 9px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    background: none; border: none;
    border-left: 1px solid var(--mute);
    border-right: 1px solid var(--mute);
    padding: 7px 16px;
    cursor: pointer;
    color: var(--dim);
    transition: color 0.12s;
  }
  .pag button:hover:not(:disabled) { color: var(--bright); }
  .pag button:disabled { opacity: 0.15; cursor: default; }

  .pag .pi {
    font-size: 8px;
    padding: 7px 12px;
    color: #333;
    font-variant-numeric: tabular-nums;
  }

  .foot {
    padding: 24px 16px;
    text-align: center;
    font-size: 8px;
    color: #222;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  /* ─── DETAIL VIEW ─── */
  #card-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: var(--bg);
    z-index: 200;
    display: grid;
    grid-template-columns: 1fr 1fr;
    opacity: 0;
    pointer-events: none;
  }
  #card-overlay.active {
    opacity: 1;
    pointer-events: all;
  }

  .acard-img-area {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    position: relative;
    overflow: hidden;
    background: #050505;
  }

  img.acard-img {
    max-width: 88%;
    max-height: 80vh;
    object-fit: contain;
    will-change: transform;
    transition: opacity 0.2s ease;
  }
  img.acard-img.switching { opacity: 0; }

  .acard-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #333;
    font-size: 32px;
    cursor: pointer;
    padding: 16px 10px;
    transition: color 0.15s;
    z-index: 2;
    font-family: var(--font);
  }
  .acard-arrow:hover { color: var(--bright); }
  .acard-arrow-left { left: 8px; }
  .acard-arrow-right { right: 8px; }

  .acard-dots {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
  }
  .acard-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #333;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: background 0.15s;
  }
  .acard-dot.active { background: var(--fg); }

  .acard-data {
    height: 100vh;
    overflow-y: auto;
    padding: 40px 32px 32px;
    border-left: 1px solid var(--mute);
    position: relative;
  }

  .acard-close {
    position: fixed;
    top: 0; left: 0;
    width: 40px; height: 40px;
    background: none;
    border: none;
    border-right: 1px solid var(--mute);
    border-bottom: 1px solid var(--mute);
    color: var(--dim);
    font-size: 16px;
    cursor: pointer;
    font-family: var(--font);
    transition: color 0.15s;
    z-index: 210;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .acard-close:hover { color: var(--bright); }

  .acard-title {
    font-size: 13px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--bright);
    line-height: 1.4;
  }

  .acard-artist {
    font-size: 11px;
    color: #b8a060;
    margin-top: 4px;
  }

  .acard-meta {
    margin-top: 14px;
    display: flex;
    flex-direction: column;
    gap: 3px;
  }
  .acard-meta-row {
    font-size: 10px;
    color: #555;
    display: flex;
    gap: 6px;
  }
  .acard-meta-row .ml { color: #333; width: 60px; text-transform: uppercase; font-size: 8px; letter-spacing: 0.06em; flex-shrink: 0; padding-top: 1px; }
  .acard-meta-row .mv { color: var(--fg); }

  .acard-section-head {
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--dim);
    margin-top: 24px;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid #1a1a1a;
  }

  .acard-scores {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .acard-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    height: 18px;
  }
  .acard-bar .sl {
    width: 72px;
    font-size: 9px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--dim);
    text-align: right;
    flex-shrink: 0;
  }
  .acard-bar .st {
    flex: 1;
    height: 12px;
    background: var(--mute);
  }
  .acard-bar .sf {
    height: 100%;
    transition: width 0.5s ease;
  }
  .acard-bar .sv {
    width: 36px;
    font-size: 10px;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .acard-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 4px;
  }

  .acard-link {
    display: inline-block;
    margin-top: 24px;
    font-family: var(--font);
    font-size: 9px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--dim);
    text-decoration: none;
    border: 1px solid #222;
    padding: 6px 14px;
    transition: all 0.15s;
  }
  .acard-link:hover { color: var(--bright); border-color: var(--bright); }

  .acard-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 28px;
    padding-top: 12px;
    border-top: 1px solid #1a1a1a;
  }
  .acard-nav button {
    font-family: var(--font);
    font-size: 9px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    background: none;
    border: none;
    color: var(--dim);
    cursor: pointer;
    padding: 4px 8px;
    transition: color 0.15s;
  }
  .acard-nav button:hover { color: var(--bright); }
  .acard-pos {
    font-size: 8px;
    color: #333;
    font-variant-numeric: tabular-nums;
  }

  @media (max-width: 700px) {
    #card-overlay {
      grid-template-columns: 1fr;
      grid-template-rows: 50vh 1fr;
    }
    .acard-img-area { height: 50vh; }
    .acard-data { height: auto; padding: 20px 16px; border-left: none; border-top: 1px solid var(--mute); }
  }
</style>
</head>
<body>

<nav class="stv-nav" data-stv-theme="dark" data-stv-page="analytics">
  <div class="stv-nav-center">
    <span class="stv-nav-title">Analytics</span>
  </div>
  <div class="stv-nav-right">
    <span class="stv-live-dot"></span>
    <span id="live-ct"></span>
  </div>
</nav>

<div class="hero" id="hero"></div>

<!-- CLIP -->
<div class="sec-head">CLIP Model + LAION Aesthetic</div>
<div class="cgrid">
  <div class="ccell">
    <h3>Art Score Distribution</h3>
    <div class="cwrap"><canvas id="c-art"></canvas></div>
  </div>
  <div class="ccell">
    <h3>Quality vs Uniqueness</h3>
    <div class="cwrap"><canvas id="c-qu"></canvas></div>
  </div>
</div>
<div class="strips" id="clip-strips"></div>

<!-- MARKET -->
<div class="sec-head">Market</div>
<div class="cgrid">
  <div class="ccell">
    <h3>Price Distribution</h3>
    <div class="cwrap"><canvas id="c-price"></canvas></div>
  </div>
  <div class="ccell">
    <h3>Art Score by Region</h3>
    <div class="cwrap"><canvas id="c-sreg"></canvas></div>
  </div>
</div>
<div class="strips" id="mkt-strips"></div>

<!-- EXPLORER -->
<div class="explorer-wrap">
  <div class="sec-head">Hunter</div>
  <div class="fbar" id="fbar">
    <button class="active" data-ef="all">All</button>
    <button data-ef="top-rated">Top</button>
    <button data-ef="gems">Gems</button>
    <button data-ef="deals">Deals</button>
    <button data-ef="by-artist">By Artist</button>
    <button data-ef="oil">Oil</button>
    <button data-ef="acrylic">Acrylic</button>
    <button data-ef="watercolor">Watercolor</button>
    <button data-ef="landscape">Landscape</button>
    <button data-ef="portrait">Portrait</button>
    <button data-ef="abstract-clip">Abstract</button>
    <button data-ef="signed">Signed</button>
  </div>
  <div class="explorer-count" id="exp-count"></div>
  <div class="tbl-wrap">
    <table class="dtbl" id="dtbl">
      <thead>
        <tr>
          <th style="width:50px"></th>
          <th data-sort="title">Title</th>
          <th data-sort="price" style="width:72px">Price</th>
          <th data-sort="region" style="width:60px">Region</th>
          <th style="width:180px">Tags</th>
          <th data-sort="art_score" class="sorted" style="width:52px">Score</th>
          <th data-sort="value_score" style="width:52px">Value</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="pag" id="pag"></div>
</div>

<div id="card-overlay">
  <button class="acard-close" id="card-close">&#8249;</button>
  <div class="acard-img-area">
    <button class="acard-arrow acard-arrow-left" id="card-arrow-left">&#8249;</button>
    <img class="acard-img" id="card-img" src="" alt="">
    <button class="acard-arrow acard-arrow-right" id="card-arrow-right">&#8250;</button>
    <div class="acard-dots" id="card-dots"></div>
  </div>
  <div class="acard-data" id="card-data">
    <div class="acard-title" id="card-title"></div>
    <div class="acard-artist" id="card-artist"></div>
    <div class="acard-meta" id="card-meta"></div>
    <div class="acard-section-head">Scores</div>
    <div class="acard-scores" id="card-scores"></div>
    <div class="acard-section-head">Tags</div>
    <div class="acard-tags" id="card-tags"></div>
    <a class="acard-link" id="card-link" href="#" target="_blank" rel="noopener">View on Craigslist &#8599;</a>
    <div class="acard-nav">
      <button id="card-prev">&#8249; Prev</button>
      <span class="acard-pos" id="card-pos"></span>
      <button id="card-next">Next &#8250;</button>
    </div>
  </div>
</div>

<div class="foot">Stevenson / California Paintings / CLIP ViT-L/14 + LAION Aesthetic</div>

<script>
const RL={losangeles:'LA',sfbay:'SF',sandiego:'SD',sacramento:'Sac',fresno:'Fres',bakersfield:'Bako',orangecounty:'OC',inlandempire:'IE',ventura:'Vent',santabarbara:'SB',stockton:'Stock',modesto:'Mod',visalia:'Vis',merced:'Merc',monterey:'Mont',chico:'Chico',redding:'Red',humboldt:'Hum',mendocino:'Mendo',goldcountry:'Gold',susanville:'Susan',yubasutter:'Yuba',palmsprings:'PS',imperial:'Imp',slo:'SLO',hanford:'Han',siskiyou:'Sisk'};
const MEDIUMS={oil:/\boil\b/i,acrylic:/\bacrylic\b/i,watercolor:/\bwater\s?colou?r\b/i,pastel:/\bpastel\b/i,gouache:/\bgouache\b/i,spray:/\bspray\b/i,ink:/\bink\b/i,mixed:/\bmixed\s?media\b/i,print:/\bprint\b|\blithograph\b|\bserigraph\b|\bgiclee\b/i};
const FLAGS={signed:/\bsigned\b|\bsignature\b/i,framed:/\bframed\b|\bframe\b/i,large:/\blarge\b|\bhuge\b|\boversized\b|\b\d{2,3}\s*x\s*\d{2,3}\b/i,original:/\boriginal\b/i};

function classify(t){const r={mediums:[],flags:[]};for(const[k,x]of Object.entries(MEDIUMS))if(x.test(t))r.mediums.push(k);for(const[k,x]of Object.entries(FLAGS))if(x.test(t))r.flags.push(k);return r;}
function deals(items){const g={};for(const i of items){const k=i.tags.mediums[0]||'x';if(!g[k])g[k]=[];if(i.price)g[k].push(i.price);}const m={};for(const[k,p]of Object.entries(g)){const s=p.sort((a,b)=>a-b);m[k]=s[Math.floor(s.length/2)]||100;}for(const i of items){if(!i.price){i.ds=0;continue;}const k=i.tags.mediums[0]||'x',r=(m[k]-i.price)/m[k];let b=0;if(i.tags.flags.includes('signed'))b+=.15;if(i.tags.flags.includes('original'))b+=.15;if(i.tags.flags.includes('framed'))b+=.1;i.ds=Math.round(Math.min(100,Math.max(0,(r+b)*100)));}}

Chart.defaults.font.family="'IBM Plex Mono',monospace";
Chart.defaults.font.size=8;
Chart.defaults.color='#666';
Chart.defaults.plugins.legend.display=false;

let all=[],exp=[],pg=0,sort={key:'art_score',dir:-1};
const PS=40;

// Phase 1: Hero stats (fast, small payload)
fetch('/api/stats').then(r=>r.json()).then(s=>{
  document.getElementById('hero').innerHTML=[
    {n:parseInt(s.total_listings).toLocaleString(),l:'Listings',s:'California'},
    {n:s.regions,l:'Regions',s:'CL markets'},
    {n:'$'+parseFloat(s.price_median).toLocaleString(),l:'Med. Price',s:'$'+parseFloat(s.price_min)+'–$'+parseFloat(s.price_max).toLocaleString()},
    {n:parseFloat(s.median_art_score).toFixed(1),l:'Art Score',s:s.scored_count+' CLIP+LAION scored'},
    {n:s.top_rated_count,l:'Top Rated',s:'Score 55+'},
    {n:s.gems_count,l:'Gems',s:'Value 8+'},
  ].map(s=>`<div class="hero-stat"><div class="num">${s.n}</div><div class="lbl">${s.l}</div><div class="sub">${s.s}</div></div>`).join('');
});

// Phase 2: Full data for charts + explorer
fetch('/api/paintings').then(r=>r.json()).then(d=>{
  all=d.paintings.filter(p=>p.images&&p.images.length>0).map(p=>({...p,tags:classify(p.title)}));
  deals(all);
  document.getElementById('live-ct').textContent=all.length.toLocaleString()+' listings';
  charts();filter('all');
});

function charts(){
  // Art score distribution
  const sc=all.filter(p=>p.art_score!=null);
  const bins=[0,20,30,40,50,60,70,80,100];
  const labels=['<20','20–30','30–40','40–50','50–60','60–70','70–80','80+'];
  const cn=new Array(labels.length).fill(0);
  sc.forEach(p=>{const s=p.art_score;for(let i=0;i<bins.length-1;i++){if(s>=bins[i]&&s<bins[i+1]){cn[i]++;break;}}});
  const barColors=['#221111','#332222','#443322','#665533','#886644','#aa8855','#ccbb66','#30d158'];
  new Chart(document.getElementById('c-art'),{
    type:'bar',
    data:{labels:labels,datasets:[{data:cn,backgroundColor:barColors,borderRadius:0,barPercentage:0.8}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false},border:{color:'#1e1e1e'}},y:{grid:{color:'#151515'},border:{color:'#1e1e1e'}}}},
  });

  // Q vs U scatter
  const sf=all.filter(p=>p.quality_score!=null&&p.uniqueness!=null);
  const sMin=Math.min(...sf.map(p=>p.art_score||0)),sMax=Math.max(...sf.map(p=>p.art_score||0));
  const sd=sf.map(p=>({x:p.quality_score,y:p.uniqueness}));
  const sColors=sf.map(p=>{const t=((p.art_score||0)-sMin)/(sMax-sMin||1);return `hsla(${Math.round(t*120)},70%,50%,0.25)`;});
  const sBorders=sf.map(p=>{const t=((p.art_score||0)-sMin)/(sMax-sMin||1);return `hsla(${Math.round(t*120)},70%,50%,0.5)`;});
  new Chart(document.getElementById('c-qu'),{
    type:'scatter',
    data:{datasets:[{data:sd,backgroundColor:sColors,borderColor:sBorders,pointRadius:2.5,pointHoverRadius:5,pointHoverBackgroundColor:'#fff'}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:'QUALITY',font:{size:7,weight:'600'},color:'#777'},grid:{color:'#151515'},border:{color:'#1e1e1e'}},y:{title:{display:true,text:'UNIQUENESS',font:{size:7,weight:'600'},color:'#777'},grid:{color:'#151515'},border:{color:'#1e1e1e'}}}},
  });

  // Price distribution
  const bk=[0,25,50,100,200,500,1000,5000,Infinity],lb=['<25','25','50','100','200','500','1K','5K+'],pc=new Array(8).fill(0);
  all.forEach(p=>{if(!p.price)return;for(let i=0;i<bk.length-1;i++){if(p.price>=bk[i]&&p.price<bk[i+1]){pc[i]++;break;}}});
  new Chart(document.getElementById('c-price'),{
    type:'bar',
    data:{labels:lb,datasets:[{data:pc,backgroundColor:['#1a3344','#1e4455','#225566','#266677','#2a7788','#2e8899','#339aaa','#38abbb'],borderRadius:0,barPercentage:0.8}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false},border:{color:'#1e1e1e'}},y:{grid:{color:'#151515'},border:{color:'#1e1e1e'}}}},
  });

  // Score by region
  const rg={};
  all.forEach(p=>{if(p.art_score==null)return;if(!rg[p.region])rg[p.region]=[];rg[p.region].push(p.art_score);});
  const re=Object.entries(rg).filter(([,s])=>s.length>=5).map(([r,s])=>[RL[r]||r,s.reduce((a,b)=>a+b,0)/s.length]).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const avgMin=re.length?Math.min(...re.map(([,s])=>s)):0;
  const avgMax=re.length?Math.max(...re.map(([,s])=>s)):1;
  const regColors=re.map(([,s])=>{const t=(s-avgMin)/(avgMax-avgMin||1);return `hsl(${30+t*20},${50+t*30}%,${35+t*25}%)`;});
  new Chart(document.getElementById('c-sreg'),{
    type:'bar',
    data:{labels:re.map(([r])=>r),datasets:[{data:re.map(([,s])=>s),backgroundColor:regColors,hoverBackgroundColor:'#fff',borderRadius:0,barPercentage:0.8}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false},border:{color:'#1e1e1e'}},y:{grid:{color:'#151515'},border:{color:'#1e1e1e'},min:avgMin>5?avgMin-5:0}}},
  });

  renderStrips();
}

function mkStrip(items,max,hue){
  return items.map(([n,c],i)=>{
    const pct=(c/max*100).toFixed(1);
    const light=35+((c/max)*20);
    const col=`hsl(${hue},50%,${light}%)`;
    return `<div class="sbar"><span class="sl">${n}</span><div class="st"><div class="sf" style="width:${pct}%;background:${col}"></div></div><span class="sv">${c}</span></div>`;
  }).join('');
}

function renderStrips(){
  // CLIP styles + artists
  const stc={};
  all.forEach(p=>{if(!p.clip_styles||!p.clip_styles.length)return;stc[p.clip_styles[0].style]=(stc[p.clip_styles[0].style]||0)+1;});
  const sts=Object.entries(stc).sort((a,b)=>b[1]-a[1]);

  const artc={};
  all.forEach(p=>{if(p.artist)artc[p.artist]=(artc[p.artist]||0)+1;});
  const arts=Object.entries(artc).sort((a,b)=>b[1]-a[1]).slice(0,10);

  document.getElementById('clip-strips').innerHTML=
    `<div class="strip-col"><h4>CLIP Styles</h4>${mkStrip(sts,sts[0]?.[1]||1,270)}</div>`+
    `<div class="strip-col"><h4>Artists Found</h4>${arts.length?mkStrip(arts,arts[0]?.[1]||1,45):'<span style="color:#333;font-size:9px">No artists parsed yet</span>'}</div>`;

  // Regions + mediums
  const rgc={};
  all.forEach(p=>{rgc[p.region]=(rgc[p.region]||0)+1;});
  const rgs=Object.entries(rgc).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([r,c])=>[RL[r]||r,c]);

  const mdc={};
  all.forEach(p=>{p.tags.mediums.forEach(m=>{mdc[m]=(mdc[m]||0)+1;});});
  const mds=Object.entries(mdc).sort((a,b)=>b[1]-a[1]);

  document.getElementById('mkt-strips').innerHTML=
    `<div class="strip-col"><h4>Regions</h4>${mkStrip(rgs,rgs[0]?.[1]||1,200)}</div>`+
    `<div class="strip-col"><h4>Mediums (NLP)</h4>${mkStrip(mds,mds[0]?.[1]||1,140)}</div>`;
}

// ─── EXPLORER ───
function filter(f){
  pg=0;
  document.querySelectorAll('#fbar button').forEach(b=>b.classList.toggle('active',b.dataset.ef===f));
  switch(f){
    case 'top-rated':exp=all.filter(p=>p.art_score>=50).sort((a,b)=>(b.art_score||0)-(a.art_score||0));break;
    case 'gems':exp=all.filter(p=>p.value_score!=null).sort((a,b)=>(b.value_score||0)-(a.value_score||0));break;
    case 'deals':exp=all.filter(p=>p.ds>=50).sort((a,b)=>b.ds-a.ds);break;
    case 'by-artist':exp=all.filter(p=>p.artist);break;
    case 'oil':exp=all.filter(p=>p.tags.mediums.includes('oil'));break;
    case 'acrylic':exp=all.filter(p=>p.tags.mediums.includes('acrylic'));break;
    case 'watercolor':exp=all.filter(p=>p.tags.mediums.includes('watercolor'));break;
    case 'landscape':exp=all.filter(p=>p.clip_styles&&p.clip_styles[0]&&p.clip_styles[0].style==='landscape');break;
    case 'portrait':exp=all.filter(p=>p.clip_styles&&p.clip_styles[0]&&p.clip_styles[0].style==='portrait');break;
    case 'abstract-clip':exp=all.filter(p=>p.clip_styles&&p.clip_styles[0]&&p.clip_styles[0].style==='abstract');break;
    case 'signed':exp=all.filter(p=>p.tags.flags.includes('signed'));break;
    default:exp=[...all];
  }
  doSort();
}

document.querySelectorAll('#fbar button').forEach(b=>b.addEventListener('click',()=>filter(b.dataset.ef)));

document.querySelectorAll('.dtbl th[data-sort]').forEach(th=>{
  th.addEventListener('click',()=>{
    const k=th.dataset.sort;
    if(sort.key===k)sort.dir*=-1;else sort={key:k,dir:-1};
    document.querySelectorAll('.dtbl th').forEach(h=>h.classList.remove('sorted'));
    th.classList.add('sorted');
    pg=0;doSort();
  });
});

function doSort(){
  const{key,dir}=sort;
  exp.sort((a,b)=>{let va,vb;switch(key){case'price':va=a.price||0;vb=b.price||0;break;case'art_score':va=a.art_score||0;vb=b.art_score||0;break;case'value_score':va=a.value_score||0;vb=b.value_score||0;break;case'region':va=a.region;vb=b.region;break;default:va=a.title.toLowerCase();vb=b.title.toLowerCase();}return va<vb?-dir:va>vb?dir:0;});
  tbl();
}

function scoreColor(v){
  if(!v)return '#222';
  // Dynamic color based on score range (works for 0-100)
  const t=Math.max(0,Math.min(1,v/100));
  const h=Math.round(t*120);
  if(v>=70)return `hsl(${h},70%,55%)`;
  if(v>=55)return `hsl(${h},60%,50%)`;
  if(v>=40)return `hsl(${h},40%,40%)`;
  return '#333';
}

function tbl(){
  const s=pg*PS,p=exp.slice(s,s+PS),body=document.getElementById('tbody');
  document.getElementById('exp-count').textContent=exp.length+' results \u00b7 page '+(pg+1)+'/'+Math.ceil(exp.length/PS);
  body.innerHTML=p.map((i,idx)=>{
    const absIdx=s+idx;
    const tags=[
      ...i.tags.mediums.map(t=>`<span class="tag medium">${t}</span>`),
      ...(i.clip_styles||[]).slice(0,1).map(s=>`<span class="tag style">${s.style}</span>`),
      ...(i.artist?[`<span class="tag artist">${i.artist}</span>`]:[]),
      ...i.tags.flags.map(t=>`<span class="tag">${t}</span>`),
    ].join('');
    const v=i.art_score||0;
    const vs=i.value_score;
    return `<tr onclick="openCard(${absIdx},this.querySelector('.thumb'))" style="cursor:pointer"><td><img class="thumb" src="${i.images[0]}" loading="lazy"></td><td class="tc">${i.title}</td><td>${i.price?'$'+i.price.toLocaleString():'\u2014'}</td><td>${RL[i.region]||i.region}</td><td>${tags||'\u2014'}</td><td class="sc" style="color:${scoreColor(v)}">${v?v.toFixed(1):'\u2014'}</td><td class="sc" style="color:${vs?scoreColor(vs*10):'#222'}">${vs?vs.toFixed(1):'\u2014'}</td></tr>`;
  }).join('');
  pagi();
}

function pagi(){
  const t=Math.ceil(exp.length/PS),el=document.getElementById('pag');
  if(t<=1){el.innerHTML='';return;}
  el.innerHTML=`<button ${pg===0?'disabled':''} onclick="pg--;tbl()">Prev</button><span class="pi">${pg+1}/${t} &middot; ${exp.length}</span><button ${pg>=t-1?'disabled':''} onclick="pg++;tbl()">Next</button>`;
}

// ─── CARD DETAIL ───
let cardOpen=false, cardIndex=-1, cardImgIndex=0, cardFlipTimeouts=[];

const overlay=document.getElementById('card-overlay');
const cardImg=document.getElementById('card-img');
const cardData=document.getElementById('card-data');

function openCard(rowIndex, thumbEl){
  cardOpen=true;
  cardIndex=rowIndex;
  cardImgIndex=0;
  const painting=exp[rowIndex];
  if(!painting)return;
  populateCard(painting);

  // Clear previous timeouts
  cardFlipTimeouts.forEach(t=>clearTimeout(t));
  cardFlipTimeouts=[];

  // Reset all inline styles
  overlay.style.cssText='';
  cardImg.style.cssText='';
  cardData.style.cssText='';

  // Get thumb rect BEFORE layout changes
  let thumbRect=null;
  if(thumbEl) thumbRect=thumbEl.getBoundingClientRect();

  // Prep data panel hidden (will slide in)
  cardData.style.opacity='0';
  cardData.style.transform='translateY(20px)';

  // Show overlay instantly but transparent — image visible, bg not yet
  overlay.style.background='rgba(5,5,5,0)';
  overlay.style.opacity='1';
  overlay.classList.add('active');

  requestAnimationFrame(()=>{
    const finalRect=cardImg.getBoundingClientRect();

    if(thumbRect && finalRect.width>0 && finalRect.height>0){
      // Invert: place image at thumbnail position
      const dx=(thumbRect.left+thumbRect.width/2)-(finalRect.left+finalRect.width/2);
      const dy=(thumbRect.top+thumbRect.height/2)-(finalRect.top+finalRect.height/2);
      const s=Math.min(thumbRect.width/finalRect.width, thumbRect.height/finalRect.height);

      cardImg.style.transition='none';
      cardImg.style.transform=`translate(${dx}px,${dy}px) scale(${s})`;

      requestAnimationFrame(()=>{
        // Play: background washes in while image flies to final position
        overlay.style.transition='background 0.45s ease';
        overlay.style.background='';

        cardImg.style.transition='transform 0.55s cubic-bezier(0.34, 1.56, 0.64, 1)';
        cardImg.style.transform='none';

        // Stagger data panel in
        cardFlipTimeouts.push(setTimeout(()=>{
          cardData.style.transition='opacity 0.35s ease, transform 0.35s ease';
          cardData.style.opacity='1';
          cardData.style.transform='none';
        },150));

        // Cleanup after animation
        cardFlipTimeouts.push(setTimeout(()=>{
          overlay.style.cssText='';
          cardImg.style.cssText='';
          cardData.style.cssText='';
        },650));
      });
    } else {
      // No thumb — fallback fade
      overlay.style.transition='background 0.35s ease, opacity 0.35s ease';
      overlay.style.background='';
      cardData.style.transition='opacity 0.35s ease, transform 0.35s ease';
      cardData.style.opacity='1';
      cardData.style.transform='none';

      cardFlipTimeouts.push(setTimeout(()=>{
        overlay.style.cssText='';
        cardData.style.cssText='';
      },400));
    }
  });

  document.body.style.overflow='hidden';
  if (window.stvMenuBtn) window.stvMenuBtn.classList.add('stv-menu-btn--hidden');
}

function closeCard(){
  if(!cardOpen)return;
  cardFlipTimeouts.forEach(t=>clearTimeout(t));
  cardFlipTimeouts=[];

  // Find the table row thumbnail to FLIP back to
  const rows=document.querySelectorAll('#tbody tr');
  const pageOffset=pg*PS;
  const rowIdx=cardIndex-pageOffset;
  let thumbRect=null;
  if(rowIdx>=0 && rowIdx<rows.length){
    const thumb=rows[rowIdx].querySelector('.thumb');
    if(thumb) thumbRect=thumb.getBoundingClientRect();
  }

  const imgRect=cardImg.getBoundingClientRect();

  // Hide data panel fast
  cardData.style.transition='opacity 0.15s ease';
  cardData.style.opacity='0';

  if(thumbRect && imgRect.width>0 && imgRect.height>0){
    const dx=(thumbRect.left+thumbRect.width/2)-(imgRect.left+imgRect.width/2);
    const dy=(thumbRect.top+thumbRect.height/2)-(imgRect.top+imgRect.height/2);
    const s=Math.min(thumbRect.width/imgRect.width, thumbRect.height/imgRect.height);

    // Fly image back to thumbnail
    cardImg.style.transition='transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    cardImg.style.transform=`translate(${dx}px,${dy}px) scale(${s})`;

    // Fade background to transparent
    overlay.style.transition='background 0.35s ease';
    overlay.style.background='rgba(5,5,5,0)';

    cardFlipTimeouts.push(setTimeout(()=>{
      overlay.classList.remove('active');
      overlay.style.cssText='';
      cardImg.style.cssText='';
      cardData.style.cssText='';
      cardOpen=false;
      document.body.style.overflow='';
      if (window.stvMenuBtn) window.stvMenuBtn.classList.remove('stv-menu-btn--hidden');
    },450));
  } else {
    // Fallback
    overlay.style.transition='opacity 0.3s ease';
    overlay.style.opacity='0';

    cardFlipTimeouts.push(setTimeout(()=>{
      overlay.classList.remove('active');
      overlay.style.cssText='';
      cardImg.style.cssText='';
      cardData.style.cssText='';
      cardOpen=false;
      document.body.style.overflow='';
      if (window.stvMenuBtn) window.stvMenuBtn.classList.remove('stv-menu-btn--hidden');
    },350));
  }
}

function populateCard(painting){
  // Title
  document.getElementById('card-title').textContent=painting.title;

  // Artist
  const artistEl=document.getElementById('card-artist');
  if(painting.artist){
    artistEl.textContent=painting.artist;
    artistEl.style.display='';
  } else {
    artistEl.style.display='none';
  }

  // Meta
  const metaRows=[];
  if(painting.price) metaRows.push({l:'Price',v:'$'+painting.price.toLocaleString()});
  metaRows.push({l:'Region',v:RL[painting.region]||painting.region});
  if(painting.location) metaRows.push({l:'Location',v:painting.location});
  if(painting.date_posted) metaRows.push({l:'Posted',v:painting.date_posted});
  document.getElementById('card-meta').innerHTML=metaRows.map(r=>
    `<div class="acard-meta-row"><span class="ml">${r.l}</span><span class="mv">${r.v}</span></div>`
  ).join('');

  // Scores
  const scores=[];
  if(painting.art_score!=null) scores.push({l:'Art',v:painting.art_score,max:100});
  if(painting.value_score!=null) scores.push({l:'Value',v:painting.value_score,max:10});
  if(painting.quality_score!=null) scores.push({l:'Quality',v:painting.quality_score,max:100});
  if(painting.uniqueness!=null) scores.push({l:'Unique',v:painting.uniqueness,max:100});
  if(painting.aesthetic_score!=null) scores.push({l:'Aesthetic',v:painting.aesthetic_score,max:10});

  document.getElementById('card-scores').innerHTML=scores.map(s=>{
    const pct=Math.min(100,(s.v/s.max)*100).toFixed(1);
    const normFor100=s.max===10?s.v*10:s.v;
    const col=scoreColor(normFor100);
    return `<div class="acard-bar"><span class="sl">${s.l}</span><div class="st"><div class="sf" style="width:${pct}%;background:${col}"></div></div><span class="sv" style="color:${col}">${s.v.toFixed(1)}</span></div>`;
  }).join('');

  // Tags
  const t=painting.tags;
  const tagHtml=[
    ...t.mediums.map(m=>`<span class="tag medium">${m}</span>`),
    ...(painting.clip_styles||[]).map(s=>`<span class="tag style">${s.style}</span>`),
    ...(painting.artist?[`<span class="tag artist">${painting.artist}</span>`]:[]),
    ...t.flags.map(f=>`<span class="tag">${f}</span>`),
  ].join('');
  document.getElementById('card-tags').innerHTML=tagHtml||'<span style="color:#333;font-size:9px">None</span>';

  // Link
  document.getElementById('card-link').href=painting.url||'#';

  // Position
  document.getElementById('card-pos').textContent=(cardIndex+1)+' of '+exp.length;

  // Image
  cardImgIndex=0;
  cardImg.src=painting.images[0];
  renderDots(painting);
  updateArrows(painting);
}

function renderDots(painting){
  const dotsEl=document.getElementById('card-dots');
  if(!painting.images||painting.images.length<=1){
    dotsEl.innerHTML='';
    return;
  }
  dotsEl.innerHTML=painting.images.map((_,i)=>
    `<button class="acard-dot${i===cardImgIndex?' active':''}" data-di="${i}"></button>`
  ).join('');
}

function updateArrows(painting){
  const hasMulti=painting.images&&painting.images.length>1;
  document.getElementById('card-arrow-left').style.display=hasMulti?'':'none';
  document.getElementById('card-arrow-right').style.display=hasMulti?'':'none';
}

function cardGoImage(idx){
  const painting=exp[cardIndex];
  if(!painting||!painting.images)return;
  const len=painting.images.length;
  cardImgIndex=((idx%len)+len)%len;

  cardImg.classList.add('switching');
  setTimeout(()=>{
    cardImg.src=painting.images[cardImgIndex];
    cardImg.classList.remove('switching');
  },200);

  document.querySelectorAll('.acard-dot').forEach((d,i)=>{
    d.classList.toggle('active',i===cardImgIndex);
  });
}

function cardPrev(){
  if(cardIndex<=0)return;
  cardIndex--;
  cardImgIndex=0;
  // Crossfade
  cardData.style.transition='opacity 0.15s ease';
  cardData.style.opacity='0';
  cardImg.classList.add('switching');
  setTimeout(()=>{
    populateCard(exp[cardIndex]);
    cardImg.classList.remove('switching');
    cardData.style.opacity='1';
  },200);
  setTimeout(()=>{cardData.style.transition='';},400);
}

function cardNext(){
  if(cardIndex>=exp.length-1)return;
  cardIndex++;
  cardImgIndex=0;
  cardData.style.transition='opacity 0.15s ease';
  cardData.style.opacity='0';
  cardImg.classList.add('switching');
  setTimeout(()=>{
    populateCard(exp[cardIndex]);
    cardImg.classList.remove('switching');
    cardData.style.opacity='1';
  },200);
  setTimeout(()=>{cardData.style.transition='';},400);
}

// Event listeners
document.getElementById('card-close').addEventListener('click',closeCard);
document.getElementById('card-prev').addEventListener('click',cardPrev);
document.getElementById('card-next').addEventListener('click',cardNext);
document.getElementById('card-arrow-left').addEventListener('click',(e)=>{e.stopPropagation();cardGoImage(cardImgIndex-1);});
document.getElementById('card-arrow-right').addEventListener('click',(e)=>{e.stopPropagation();cardGoImage(cardImgIndex+1);});
document.getElementById('card-dots').addEventListener('click',(e)=>{
  const dot=e.target.closest('.acard-dot');
  if(dot) cardGoImage(parseInt(dot.dataset.di));
});

// Keyboard
document.addEventListener('keydown',(e)=>{
  if(!cardOpen)return;
  switch(e.key){
    case 'Escape': closeCard(); break;
    case 'ArrowLeft': e.preventDefault(); cardGoImage(cardImgIndex-1); break;
    case 'ArrowRight': e.preventDefault(); cardGoImage(cardImgIndex+1); break;
    case 'ArrowUp': e.preventDefault(); cardPrev(); break;
    case 'ArrowDown': e.preventDefault(); cardNext(); break;
  }
});
</script>
<script src="stv-nav.js"></script>
</body>
</html>
